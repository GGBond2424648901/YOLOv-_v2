<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOvæ™ºèƒ½æ ‡æ³¨å·¥å…·</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px; /* æ‰©å¤§æœ€å¤§å®½åº¦ */
            margin: 0 auto;
            padding: 15px; /* å‡å°‘padding */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 20px; /* å‡å°‘margin */
            color: white;
        }

        .header h1 {
            font-size: 2.2rem; /* ç¨å¾®å‡å°å­—ä½“ */
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.0rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 320px; /* ç¨å¾®æ‰©å¤§ä¾§è¾¹æ  */
            gap: 15px; /* å‡å°‘é—´è· */
            height: calc(100vh - 120px); /* å‡å°‘é¡¶éƒ¨ç©ºé—´ */
            max-width: 1600px; /* æ‰©å¤§æœ€å¤§å®½åº¦ */
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow-y: auto;
        }

        .center-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px; /* å‡å°‘padding */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            display: flex;
            flex-direction: column;
            position: relative; /* ç¡®ä¿ç›¸å¯¹å®šä½ */
            min-width: 0; /* é˜²æ­¢flexæ”¶ç¼©é—®é¢˜ */
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6fffa;
        }

        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .canvas-container {
            width: 100%; /* å›ºå®šå®½åº¦ä¸ºå®¹å™¨100% */
            height: 650px; /* å¢åŠ å›ºå®šé«˜åº¦ */
            min-height: 650px; /* æœ€å°é«˜åº¦ */
            max-height: 650px; /* æœ€å¤§é«˜åº¦ */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0; /* é˜²æ­¢flexå®¹å™¨æ”¶ç¼© */
            flex-grow: 0; /* é˜²æ­¢flexå®¹å™¨å¢é•¿ */
            margin: 0; /* ç¡®ä¿æ²¡æœ‰å¤–è¾¹è· */
        }

        #annotationCanvas {
            max-width: calc(100% - 20px); /* ç•™å‡ºè¾¹è· */
            max-height: calc(100% - 20px); /* ç•™å‡ºè¾¹è· */
            cursor: crosshair;
            border-radius: 8px;
            object-fit: contain; /* ä¿æŒå®½é«˜æ¯”ï¼Œå®Œå…¨æ˜¾ç¤ºåœ¨å®¹å™¨å†… */
            display: block; /* ç¡®ä¿å—çº§æ˜¾ç¤º */
        }

        #videoPlayer {
            max-width: calc(100% - 20px); /* ç•™å‡ºè¾¹è· */
            max-height: calc(100% - 20px); /* ç•™å‡ºè¾¹è· */
            border-radius: 8px;
            object-fit: contain; /* ä¿æŒå®½é«˜æ¯”ï¼Œå®Œå…¨æ˜¾ç¤ºåœ¨å®¹å™¨å†… */
            display: block; /* ç¡®ä¿å—çº§æ˜¾ç¤º */
        }

        #placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .model-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .model-info.loaded {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .model-info h4 {
            color: #234e52;
            margin-bottom: 5px;
        }

        .class-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 5px;
            background: #f8fafc;
        }

        .class-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            background: #fff;
            border-radius: 6px;
            margin-bottom: 3px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .class-item:hover {
            background: #f0f4ff;
            transform: translateX(2px);
        }

        .class-item.selected {
            background: #e6f3ff;
            border-left-color: #4299e1;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.2);
        }

        .class-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .class-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .class-name {
            flex: 1;
            margin: 0 10px;
            font-weight: 500;
        }

        .class-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .annotation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .annotation-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .annotation-details {
            flex: 1;
        }

        .annotation-class {
            font-weight: 600;
            color: #2d3748;
        }

        .annotation-confidence {
            font-size: 12px;
            color: #718096;
        }

        .annotation-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 5px 8px;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-ready {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-processing {
            background: #feebc8;
            color: #744210;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .video-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }

        #videoPlayer {
            width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }

        .hidden {
            display: none !important;
        }

        .batch-controls {
            background: #f0f8ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .export-options {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 15px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #48bb78;
        }

        .notification.error {
            background: #f56565;
        }

        .notification.info {
            background: #4299e1;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            
            .sidebar {
                height: auto;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .drag-active {
            border-color: #667eea !important;
            background: #e6f3ff !important;
        }
        
        /* å›¾ç‰‡åˆ—è¡¨æ ·å¼ */
        .image-list-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #fff;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }
        
        .image-list-item:hover {
            background: #f0f4ff;
            border-color: #667eea;
            transform: translateX(2px);
        }
        
        .image-list-item.active {
            background: #e6f3ff;
            border-color: #4299e1;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.2);
        }
        
        .image-list-item.annotated {
            border-left: 3px solid #48bb78;
        }
        
        .image-status-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
            background: #fff;
            font-size: 12px;
        }
        
        .image-status-icon.annotated {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }
        
        .image-list-filename {
            flex: 1;
            font-size: 11px;
            color: #4a5568;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        .image-list-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .image-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .image-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        
        .image-list-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-eye"></i> YOLOvæ™ºèƒ½æ ‡æ³¨å·¥å…· 
                <span style="font-size: 0.5em; color: #667eea; cursor: pointer;" onclick="showVersionInfo()">v2.0</span>
            </h1>
            <p>ä¸Šä¼ æ¨¡å‹ï¼Œè‡ªåŠ¨æ ‡æ³¨å›¾ç‰‡å’Œè§†é¢‘ï¼Œå¯¼å‡ºè®­ç»ƒæ•°æ® 
                <span style="font-size: 0.8em; color: #888; margin-left: 10px;">
                    æŒ‰ <kbd>H</kbd> æŸ¥çœ‹å¿«æ·é”®
                </span>
            </p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§æ  - æ¨¡å‹å’Œè®¾ç½® -->
            <div class="sidebar">
                <div class="section-title">
                    <i class="fas fa-brain"></i>
                    æ¨¡å‹ç®¡ç†
                </div>
                
                <div class="model-tabs" style="margin-bottom: 15px;">
                    <button class="btn btn-sm" id="uploadTab" onclick="switchModelTab('upload')" style="margin-right: 5px;">
                        <i class="fas fa-upload"></i> ä¸Šä¼ æ¨¡å‹
                    </button>
                    <button class="btn btn-sm btn-secondary" id="existingTab" onclick="switchModelTab('existing')">
                        <i class="fas fa-folder"></i> é€‰æ‹©ç°æœ‰æ¨¡å‹
                    </button>
                </div>

                <div id="uploadModelPanel">
                    <div class="upload-area" onclick="document.getElementById('modelFile').click()">
                        <div class="upload-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ YOLOvæ¨¡å‹</p>
                        <small>æ”¯æŒ .pt æ–‡ä»¶æ ¼å¼</small>
                    </div>
                    <input type="file" id="modelFile" accept=".pt" style="display: none;">
                </div>

                <div id="existingModelPanel" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ¨¡å‹æ–‡ä»¶</label>
                        <select class="form-control" id="existingModelSelect">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="loadExistingModel()" id="loadModelBtn" disabled>
                        <i class="fas fa-download"></i>
                        åŠ è½½é€‰ä¸­æ¨¡å‹
                    </button>
                    <button class="btn btn-sm" onclick="refreshModelList()" style="margin-left: 5px;">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>

                <div class="model-info" id="modelInfo" style="display: none;">
                    <h4><i class="fas fa-check-circle"></i> æ¨¡å‹å·²åŠ è½½</h4>
                    <p id="modelDetails">ç­‰å¾…åŠ è½½...</p>
                    <div class="status-indicator status-ready">
                        <i class="fas fa-circle"></i>
                        å°±ç»ª
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ç½®ä¿¡åº¦é˜ˆå€¼</label>
                    <input type="range" class="form-control" id="confidenceThreshold" 
                           min="0.1" max="1.0" step="0.05" value="0.5">
                    <small id="confidenceValue">0.5</small>
                </div>

                <div class="form-group">
                    <label class="form-label">IoUé˜ˆå€¼</label>
                    <input type="range" class="form-control" id="iouThreshold" 
                           min="0.1" max="1.0" step="0.05" value="0.45">
                    <small id="iouValue">0.45</small>
                </div>

                <div class="form-group">
                    <label class="form-label">è¾“å…¥å°ºå¯¸</label>
                    <select class="form-control" id="inputSize">
                        <option value="640">640x640</option>
                        <option value="320">320x320</option>
                        <option value="416">416x416</option>
                        <option value="512">512x512</option>
                        <option value="1280">1280x1280</option>
                    </select>
                </div>

                <div class="batch-controls">
                    <h4><i class="fas fa-layer-group"></i> æ‰¹é‡å¤„ç†</h4>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-secondary" onclick="selectBatchFiles()" style="flex: 1; min-width: 120px;">
                            <i class="fas fa-images"></i>
                            é€‰æ‹©æ–‡ä»¶
                        </button>
                        
                        <button class="btn btn-secondary" onclick="selectBatchFolder()" style="flex: 1; min-width: 120px;">
                            <i class="fas fa-folder-open"></i>
                            é€‰æ‹©æ–‡ä»¶å¤¹
                        </button>
                    </div>
                    
                    <!-- ä¸è½®æ’­é€‰é¡¹ -->
                    <div class="form-group" style="margin: 10px 0;">
                        <label class="form-label" style="font-size: 12px; display: flex; align-items: center;">
                            <input type="checkbox" id="noCarouselMode" style="margin-right: 8px;">
                            <span>é™é»˜æ‰¹é‡æ£€æµ‹ï¼ˆä¸è½®æ’­å›¾ç‰‡ï¼‰</span>
                        </label>
                        <small style="color: #666; font-size: 11px; display: block; margin-left: 24px;">
                            ğŸ’¡ å‹¾é€‰åæ‰¹é‡æ£€æµ‹æ—¶ä¸è‡ªåŠ¨åˆ‡æ¢å›¾ç‰‡ï¼Œåªæ˜¾ç¤ºè¿›åº¦
                        </small>
                    </div>
                    
                    <button class="btn btn-warning" onclick="processBatch()" id="batchProcessBtn" disabled>
                        <i class="fas fa-play"></i>
                        ä¸€é”®æ£€æµ‹å…¨éƒ¨
                    </button>
                    
                    <!-- æ‰¹é‡å¤„ç†è¿›åº¦åŒºåŸŸ -->
                    <div class="batch-progress-container" style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <small id="batchStatus">ç­‰å¾…é€‰æ‹©æ–‡ä»¶</small>
                            <span id="batchPercentage" style="font-weight: bold; color: #667eea;">0%</span>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="batchProgress" style="width: 0%"></div>
                        </div>
                        
                        <div id="batchStats" style="margin-top: 10px; display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                                <div>
                                    <span style="color: #48bb78;">âœ“ å·²å¤„ç†: </span>
                                    <span id="processedCount">0</span>
                                </div>
                                <div>
                                    <span style="color: #4299e1;">ğŸ“Š æ£€æµ‹åˆ°: </span>
                                    <span id="detectedCount">0</span>
                                </div>
                                <div>
                                    <span style="color: #ed8936;">â³ å‰©ä½™: </span>
                                    <span id="remainingCount">0</span>
                                </div>
                                <div>
                                    <span style="color: #f56565;">âŒ æ— ç›®æ ‡: </span>
                                    <span id="emptyCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­å¤®é¢æ¿ - å›¾åƒæ˜¾ç¤ºå’Œæ ‡æ³¨ -->
            <div class="center-panel">
                <div class="toolbar">
                    <div class="upload-area" style="flex: 1; padding: 15px; margin: 0;" 
                         onclick="document.getElementById('mediaFile').click()">
                        <i class="fas fa-image"></i>
                        é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘
                    </div>
                    <input type="file" id="mediaFile" accept="image/*,video/*" multiple style="display: none;">
                    
                    <button class="btn" onclick="autoAnnotate()" id="autoAnnotateBtn" disabled>
                        <i class="fas fa-magic"></i>
                        è‡ªåŠ¨æ ‡æ³¨
                    </button>
                    
                    <button class="btn btn-secondary" onclick="clearAnnotations()">
                        <i class="fas fa-eraser"></i>
                        æ¸…é™¤å½“å‰æ ‡æ³¨
                    </button>
                    
                    <button class="btn btn-secondary" onclick="clearAllAnnotations()">
                        <i class="fas fa-trash"></i>
                        æ¸…é™¤å…¨éƒ¨æ ‡æ³¨
                    </button>
                    
                    <button class="btn btn-sm btn-danger" onclick="deleteCurrentFile()" title="åˆ é™¤å½“å‰æ–‡ä»¶">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <button class="btn btn-sm btn-warning" onclick="clearCurrentSession()" title="æ¸…é™¤å½“å‰ä¸Šä¼ çš„æ‰€æœ‰æ–‡ä»¶">
                        <i class="fas fa-folder-minus"></i> æ¸…é™¤å½“å‰
                    </button>
                    
                    <button class="btn btn-sm btn-danger" onclick="clearAllUploads()" title="æ¸…é™¤uploadsæ–‡ä»¶å¤¹æ‰€æœ‰æ–‡ä»¶">
                        <i class="fas fa-trash-alt"></i> æ¸…ç©ºæ–‡ä»¶å¤¹
                    </button>
                    
                    <button class="btn btn-sm" onclick="showShortcutsHelp()" title="å¿«æ·é”®å¸®åŠ© (H)">
                        <i class="fas fa-keyboard"></i>
                    </button>
                </div>

                <!-- å›¾ç‰‡æµè§ˆå™¨æ§åˆ¶æ  -->
                <div class="image-browser-controls" id="imageBrowserControls" style="display: none;">
                    <!-- ä¸Šæ–¹æŒ‰é’®åŒºåŸŸé‡æ–°è®¾è®¡ -->
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        
                        <!-- ç¬¬ä¸€è¡Œï¼šå¯¼èˆªå’Œä¿¡æ¯ -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="btn btn-sm" onclick="previousImage()" id="prevBtn" disabled style="min-width: 80px;">
                                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€å¼ 
                                </button>
                                <button class="btn btn-sm" onclick="nextImage()" id="nextBtn" disabled style="min-width: 80px;">
                                    ä¸‹ä¸€å¼  <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="imageInfo" style="font-size: 14px; color: #4a5568; font-weight: 500;"></span>
                                <div class="progress-bar" style="width: 180px; height: 8px; margin: 0;">
                                    <div class="progress-fill" id="imageProgress" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <button class="btn btn-sm btn-danger" onclick="deleteAllFiles()" id="deleteAllBtn" style="min-width: 100px;">
                                <i class="fas fa-trash-alt"></i> åˆ é™¤å…¨éƒ¨
                            </button>
                        </div>
                        
                        <!-- ç¬¬äºŒè¡Œï¼šåŠŸèƒ½æŒ‰é’® -->
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <button class="btn btn-secondary" onclick="autoAnnotateAll()" id="autoAnnotateAllBtn" disabled style="min-width: 140px;">
                                <i class="fas fa-magic"></i> ä¸€é”®æ£€æµ‹å…¨éƒ¨
                            </button>
                            
                            <!-- æš‚åœ/ç»§ç»­æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                            <button class="btn btn-warning" onclick="pauseResumeDetection()" id="pauseResumeBtn" style="min-width: 100px; display: none;">
                                <i class="fas fa-pause"></i> æš‚åœ
                            </button>
                            
                            <button class="btn btn-warning" onclick="clearAllAnnotations()" style="min-width: 120px;">
                                <i class="fas fa-eraser"></i> æ¸…é™¤æ ‡æ³¨
                            </button>
                            
                            <button class="btn" onclick="exportDataset()" style="min-width: 120px;">
                                <i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®é›†
                            </button>
                        </div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="annotationCanvas"></canvas>
                    <video id="videoPlayer" controls style="display: none;"></video>
                    <div id="placeholder" style="text-align: center; color: #a0aec0;">
                        <i class="fas fa-image" style="font-size: 4rem; margin-bottom: 20px;"></i>
                        <p style="font-size: 1.2rem;">è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘å¼€å§‹æ ‡æ³¨</p>
                    </div>
                </div>

                <!-- è§†é¢‘æ§åˆ¶é¢æ¿ -->
                <div class="video-controls hidden" id="videoControls">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <button class="btn btn-sm" onclick="extractFrame()">
                            <i class="fas fa-camera"></i>
                            æå–å½“å‰å¸§
                        </button>
                        
                        <button class="btn btn-sm btn-warning" onclick="showVideoExtractDialog()">
                            <i class="fas fa-film"></i>
                            æ‰¹é‡æå–å¸§
                        </button>
                        
                        <button class="btn btn-sm btn-secondary" onclick="autoAnnotateVideo()">
                            <i class="fas fa-video"></i>
                            æ ‡æ³¨è§†é¢‘
                        </button>
                        
                        <span style="margin-left: auto;">å½“å‰æ—¶é—´: <span id="currentTime">00:00</span></span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ  - ç±»åˆ«å’Œæ ‡æ³¨ç®¡ç† -->
            <div class="sidebar">
                <!-- å›¾ç‰‡åˆ—è¡¨åŒºåŸŸ -->
                <div class="image-list-section" id="imageListSection" style="display: none; margin-bottom: 15px;">
                    <div class="section-title">
                        <i class="fas fa-images"></i>
                        å›¾ç‰‡åˆ—è¡¨
                        <span id="imageListCount" style="font-size: 11px; color: #667eea; margin-left: 8px;">0å¼ </span>
                    </div>
                    
                    <div class="image-list-container" id="imageListContainer" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; padding: 5px;">
                        <p style="color: #a0aec0; text-align: center; padding: 20px; font-size: 12px;">
                            ä¸Šä¼ å›¾ç‰‡åæ˜¾ç¤ºåˆ—è¡¨
                        </p>
                    </div>
                </div>
                
                <div class="section-title">
                    <i class="fas fa-tags"></i>
                    æ£€æµ‹ç±»åˆ«
                    <button class="btn btn-sm" onclick="toggleSelectAll()" style="margin-left: auto; font-size: 10px; padding: 3px 8px;">
                        å…¨é€‰/å–æ¶ˆ
                    </button>
                </div>
                
                <div class="class-controls" style="margin-bottom: 10px;">
                    <button class="btn btn-sm btn-secondary" onclick="selectCommonClasses()" style="font-size: 10px; padding: 3px 8px; margin-right: 5px;">
                        <i class="fas fa-user"></i> å¸¸ç”¨ç±»åˆ«
                    </button>
                    <span style="font-size: 11px; color: #666;">å·²é€‰: <span id="selectedCount">0</span></span>
                </div>
                
                <div id="classList" class="class-list-container">
                    <p style="color: #a0aec0; text-align: center; padding: 20px;">
                        åŠ è½½æ¨¡å‹åæ˜¾ç¤ºç±»åˆ«
                    </p>
                </div>

                <!-- æ‰‹åŠ¨æ ‡æ³¨æ¨¡å¼è®¾ç½® -->
                <div style="margin-top: 15px;">
                    <label class="form-label">
                        <i class="fas fa-draw-polygon"></i>
                        æ ‡æ³¨æ¨¡å¼
                    </label>
                    <select id="annotationMode" class="form-control">
                        <option value="rectangle">çŸ©å½¢æ¡†æ ‡æ³¨</option>
                        <option value="polygon">å¤šè¾¹å½¢åˆ†å‰²æ ‡æ³¨</option>
                    </select>
                    <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                        å¤šè¾¹å½¢æ¨¡å¼ï¼šç‚¹å‡»æ·»åŠ ç‚¹ï¼ŒåŒå‡»æˆ–æŒ‰Enterå®Œæˆ
                    </small>
                </div>

                <!-- æ‰‹åŠ¨æ ‡æ³¨ç±»å‹è®¾ç½® -->
                <div style="margin-top: 15px;">
                    <label class="form-label">
                        <i class="fas fa-pencil-alt"></i>
                        æ‰‹åŠ¨æ ‡æ³¨ç±»å‹
                    </label>
                    <input id="manualAnnotationClass" class="form-control" 
                           list="classOptions" 
                           placeholder="è¾“å…¥æˆ–é€‰æ‹©ç±»åˆ«" 
                           disabled
                           value="person">
                    <datalist id="classOptions">
                        <option value="person">person</option>
                    </datalist>
                    <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                        å¯è¾“å…¥è‡ªå®šä¹‰ç±»åˆ«æˆ–ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©ç°æœ‰ç±»åˆ«
                    </small>
                </div>

                <div class="section-title" style="margin-top: 30px;">
                    <i class="fas fa-list"></i>
                    å½“å‰æ ‡æ³¨
                </div>
                
                <div id="annotationList">
                    <p style="color: #a0aec0; text-align: center; padding: 20px;">
                        æš‚æ— æ ‡æ³¨
                    </p>
                </div>

                <!-- æ£€æµ‹ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ -->
                <div id="detectionStatistics" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="margin-top: 0;">
                        <i class="fas fa-chart-bar"></i>
                        æ£€æµ‹ç»Ÿè®¡
                    </div>
                    <div style="background: #f0f8ff; border: 1px solid #b8daff; border-radius: 8px; padding: 12px; font-size: 13px;">
                        <div id="statisticsContent"></div>
                    </div>
                </div>

                <div class="export-options">
                    <h4><i class="fas fa-download"></i> å¯¼å‡ºé€‰é¡¹</h4>
                    
                    <div class="form-group">
                        <label class="form-label">å¯¼å‡ºæ ¼å¼</label>
                        <select class="form-control" id="exportFormat">
                            <option value="yolo_json">YOLO JSON</option>
                            <option value="coco_json">COCO JSON</option>
                            <option value="yolo_txt">YOLO TXT</option>
                            <option value="pascal_voc">Pascal VOC</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="exportAnnotations()" id="exportBtn" disabled>
                        <i class="fas fa-file-export"></i>
                        å¯¼å‡ºå½“å‰æ ‡æ³¨
                    </button>
                    
                    <div style="margin: 15px 0; padding: 10px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                        <h5 style="margin-bottom: 10px; color: #22543d;">
                            <i class="fas fa-database"></i> å®Œæ•´æ•°æ®é›†å¯¼å‡º
                        </h5>
                        
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label class="form-label" style="font-size: 12px;">æ•°æ®é›†åç§°</label>
                            <input type="text" class="form-control" id="datasetName" value="my_yolo_dataset" style="font-size: 12px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label class="form-label" style="font-size: 12px;">
                                <input type="checkbox" id="includeImages" checked style="margin-right: 5px;">
                                åŒ…å«å›¾ç‰‡æ–‡ä»¶
                            </label>
                        </div>
                        
                        <button class="btn btn-warning" onclick="exportDataset()" style="width: 100%; font-size: 12px; padding: 8px;">
                            <i class="fas fa-archive"></i>
                            å¯¼å‡ºå®Œæ•´æ•°æ®é›† (ZIP)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„å…ƒç´  -->
    <input type="file" id="batchFiles" multiple accept="image/*,video/*" style="display: none;">
    <input type="file" id="batchFolder" webkitdirectory directory multiple style="display: none;">

    <script>
        // å…¨å±€å˜é‡
        const API_BASE_URL = window.location.origin + '/api';
        let currentModel = null;
        let currentImage = null;
        let currentVideo = null;
        let annotations = [];
        let classes = [];
        let colors = [];
        let batchFiles = [];
        let canvas, ctx;
        let isDrawing = false;
        let startX, startY;
        let currentSessionId = null;
        let currentFilename = null;
        let selectedClassIds = [];  // é€‰æ‹©çš„ç±»åˆ«IDåˆ—è¡¨
        let uploadedFiles = [];  // ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
        let currentFileIndex = 0;  // å½“å‰æ–‡ä»¶ç´¢å¼•
        let batchProcessStats = {
            processed: 0,
            detected: 0,
            empty: 0,
            total: 0
        };
        
        // å¤šè¾¹å½¢æ ‡æ³¨ç›¸å…³å˜é‡
        let annotationMode = 'rectangle';  // 'rectangle' æˆ– 'polygon'
        let polygonPoints = [];  // å½“å‰å¤šè¾¹å½¢çš„ç‚¹
        let isDrawingPolygon = false;  // æ˜¯å¦æ­£åœ¨ç»˜åˆ¶å¤šè¾¹å½¢

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('annotationCanvas');
            ctx = canvas.getContext('2d');
            initializeEventListeners();
            generateColors();
            checkServerHealth();
            refreshModelList();
        });

        // ç”Ÿæˆéšæœºé¢œè‰²
        function generateColors() {
            const colorPalette = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',
                '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3', '#FF9F43',
                '#10AC84', '#EE5A24', '#0652DD', '#9980FA', '#EA2027'
            ];
            colors = colorPalette;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('modelFile').addEventListener('change', handleModelUpload);
            document.getElementById('mediaFile').addEventListener('change', handleMediaUpload);
            document.getElementById('batchFiles').addEventListener('change', handleBatchFiles);
            document.getElementById('batchFolder').addEventListener('change', handleBatchFiles);

            // æ»‘å—æ›´æ–°
            document.getElementById('confidenceThreshold').addEventListener('input', function() {
                document.getElementById('confidenceValue').textContent = this.value;
            });
            
            document.getElementById('iouThreshold').addEventListener('input', function() {
                document.getElementById('iouValue').textContent = this.value;
            });

            // æ ‡æ³¨æ¨¡å¼åˆ‡æ¢
            document.getElementById('annotationMode').addEventListener('change', function() {
                annotationMode = this.value;
                // åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½®å¤šè¾¹å½¢çŠ¶æ€
                if (annotationMode === 'polygon') {
                    isDrawing = false;
                    polygonPoints = [];
                    isDrawingPolygon = false;
                    showNotification('å¤šè¾¹å½¢æ¨¡å¼ï¼šç‚¹å‡»ç”»å¸ƒæ·»åŠ ç‚¹ï¼ŒåŒå‡»æˆ–æŒ‰Enterå®Œæˆ', 'info');
                } else {
                    polygonPoints = [];
                    isDrawingPolygon = false;
                    showNotification('çŸ©å½¢æ¡†æ¨¡å¼ï¼šæ‹–æ‹½ç”»å¸ƒç»˜åˆ¶çŸ©å½¢', 'info');
                }
                redrawCanvas();
            });

            // æ‹–æ‹½ä¸Šä¼ 
            setupDragAndDrop();

            // Canvasç»˜å›¾äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('dblclick', finishPolygon);

            // è§†é¢‘æ—¶é—´æ›´æ–°
            document.getElementById('videoPlayer').addEventListener('timeupdate', updateVideoTime);

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyDown);
        }

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const uploadAreas = document.querySelectorAll('.upload-area');
            
            uploadAreas.forEach(area => {
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if (this.onclick.toString().includes('modelFile')) {
                            handleModelFile(files[0]);
                        } else {
                            handleMediaFiles(files);
                        }
                    }
                });
            });
        }

        // æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
        function checkServerHealth() {
            fetch(`${API_BASE_URL}/health`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        showNotification('æœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success');
                        if (data.model_loaded) {
                            loadModelInfo();
                        }
                    }
                })
                .catch(error => {
                    showNotification('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨', 'error');
                    console.error('Health check failed:', error);
                });
        }

        // åŠ è½½æ¨¡å‹ä¿¡æ¯
        function loadModelInfo() {
            fetch(`${API_BASE_URL}/model_info`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log('No model loaded');
                        return;
                    }
                    currentModel = data;
                    classes = data.classes;
                    updateModelInfo();
                    updateClassList();
                    document.getElementById('autoAnnotateBtn').disabled = false;
                })
                .catch(error => {
                    console.error('Failed to load model info:', error);
                });
        }

        // åˆ‡æ¢æ¨¡å‹é€‰æ‹©æ ‡ç­¾
        function switchModelTab(tab) {
            const uploadTab = document.getElementById('uploadTab');
            const existingTab = document.getElementById('existingTab');
            const uploadPanel = document.getElementById('uploadModelPanel');
            const existingPanel = document.getElementById('existingModelPanel');

            if (tab === 'upload') {
                uploadTab.classList.remove('btn-secondary');
                existingTab.classList.add('btn-secondary');
                uploadPanel.style.display = 'block';
                existingPanel.style.display = 'none';
            } else {
                uploadTab.classList.add('btn-secondary');
                existingTab.classList.remove('btn-secondary');
                uploadPanel.style.display = 'none';
                existingPanel.style.display = 'block';
                refreshModelList();
            }
        }

        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        function refreshModelList() {
            const select = document.getElementById('existingModelSelect');
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            fetch(`${API_BASE_URL}/list_models`)
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹æ–‡ä»¶</option>';
                    
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.filename;
                            option.textContent = `${model.filename} (${model.size_mb})`;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">æ²¡æœ‰æ‰¾åˆ°æ¨¡å‹æ–‡ä»¶</option>';
                    }
                })
                .catch(error => {
                    console.error('Failed to load model list:', error);
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                });
        }

        // åŠ è½½ç°æœ‰æ¨¡å‹
        function loadExistingModel() {
            const select = document.getElementById('existingModelSelect');
            const filename = select.value;
            
            if (!filename) {
                showNotification('è¯·å…ˆé€‰æ‹©æ¨¡å‹æ–‡ä»¶', 'error');
                return;
            }

            showNotification('æ­£åœ¨åŠ è½½æ¨¡å‹...', 'info');

            fetch(`${API_BASE_URL}/load_existing_model`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filename: filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }

                currentModel = data.model_info;
                classes = data.model_info.classes;
                updateModelInfo();
                updateClassList();
                
                document.getElementById('autoAnnotateBtn').disabled = false;
                updateBatchStatus(); // æ›´æ–°æ‰¹é‡å¤„ç†æŒ‰é’®çŠ¶æ€
                showNotification('æ¨¡å‹åŠ è½½æˆåŠŸï¼', 'success');
            })
            .catch(error => {
                showNotification('æ¨¡å‹åŠ è½½å¤±è´¥: ' + error.message, 'error');
                console.error('Model loading failed:', error);
            });
        }

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('existingModelSelect');
            if (select) {
                select.addEventListener('change', function() {
                    const loadBtn = document.getElementById('loadModelBtn');
                    loadBtn.disabled = !this.value;
                });
            }
        });

        // å¤„ç†æ¨¡å‹ä¸Šä¼ 
        function handleModelUpload(event) {
            handleModelFile(event.target.files[0]);
        }

        function handleModelFile(file) {
            if (!file.name.endsWith('.pt')) {
                showNotification('è¯·ä¸Šä¼ .ptæ ¼å¼çš„æ¨¡å‹æ–‡ä»¶', 'error');
                return;
            }

            showNotification('æ­£åœ¨ä¸Šä¼ å¹¶åŠ è½½æ¨¡å‹...', 'info');
            
            const formData = new FormData();
            formData.append('file', file);

            fetch(`${API_BASE_URL}/upload_model`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }

                currentModel = data.model_info;
                classes = data.model_info.classes;
                updateModelInfo();
                updateClassList();
                
                document.getElementById('autoAnnotateBtn').disabled = false;
                updateBatchStatus(); // æ›´æ–°æ‰¹é‡å¤„ç†æŒ‰é’®çŠ¶æ€
                showNotification('æ¨¡å‹åŠ è½½æˆåŠŸï¼', 'success');
            })
            .catch(error => {
                showNotification('æ¨¡å‹ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                console.error('Model upload failed:', error);
            });
        }

        // æ›´æ–°æ¨¡å‹ä¿¡æ¯
        function updateModelInfo() {
            const modelInfo = document.getElementById('modelInfo');
            const modelDetails = document.getElementById('modelDetails');
            
            const size = currentModel.size ? 
                (currentModel.size / 1024 / 1024).toFixed(2) + ' MB' : 
                'Unknown';
            
            modelDetails.innerHTML = `
                <strong>æ–‡ä»¶:</strong> ${currentModel.filename || 'Unknown'}<br>
                <strong>å¤§å°:</strong> ${size}<br>
                <strong>ç±»åˆ«æ•°é‡:</strong> ${currentModel.num_classes || 0}<br>
                <strong>æ¨¡å‹ç±»å‹:</strong> ${currentModel.model_type || 'Unknown'}<br>
                <strong>è®¾å¤‡:</strong> ${currentModel.device || 'Unknown'}
            `;
            
            modelInfo.style.display = 'block';
        }

        // æ›´æ–°ç±»åˆ«åˆ—è¡¨
        function updateClassList() {
            const classList = document.getElementById('classList');
            const manualClassInput = document.getElementById('manualAnnotationClass');
            const classOptions = document.getElementById('classOptions');
            
            classList.innerHTML = '';
            
            if (!classes || classes.length === 0) {
                classList.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">æ²¡æœ‰ç±»åˆ«ä¿¡æ¯</p>';
                // é‡ç½®æ‰‹åŠ¨æ ‡æ³¨ç±»å‹é€‰æ‹©å™¨
                classOptions.innerHTML = '<option value="person">person</option>';
                manualClassInput.value = 'person';
                manualClassInput.disabled = true;
                return;
            }
            
            // é»˜è®¤é€‰æ‹©æ‰€æœ‰ç±»åˆ«
            selectedClassIds = classes.map((_, index) => index);
            
            // æ›´æ–°æ‰‹åŠ¨æ ‡æ³¨ç±»å‹çš„datalisté€‰é¡¹
            classOptions.innerHTML = '';
            classes.forEach((className) => {
                const option = document.createElement('option');
                option.value = className;
                classOptions.appendChild(option);
            });
            
            // è®¾ç½®é»˜è®¤å€¼ä¸ºç¬¬ä¸€ä¸ªç±»åˆ«
            manualClassInput.value = classes[0] || 'person';
            manualClassInput.disabled = false;
            
            classes.forEach((className, index) => {
                const classItem = document.createElement('div');
                classItem.className = 'class-item selected';
                classItem.innerHTML = `
                    <input type="checkbox" id="class-${index}" checked onchange="toggleClass(${index})">
                    <div class="class-color" style="background: ${colors[index % colors.length]}"></div>
                    <span class="class-name">${className}</span>
                    <span class="class-count" id="count-${index}">0</span>
                `;
                
                // ç‚¹å‡»æ•´ä¸ªé¡¹ç›®ä¹Ÿèƒ½åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                classItem.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = classItem.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleClass(index);
                    }
                });
                
                classList.appendChild(classItem);
            });
            
            updateSelectedCount();
        }

        // åˆ‡æ¢ç±»åˆ«é€‰æ‹©çŠ¶æ€
        function toggleClass(classId) {
            const checkbox = document.getElementById(`class-${classId}`);
            const classItem = checkbox.closest('.class-item');
            
            if (checkbox.checked) {
                if (!selectedClassIds.includes(classId)) {
                    selectedClassIds.push(classId);
                }
                classItem.classList.add('selected');
            } else {
                selectedClassIds = selectedClassIds.filter(id => id !== classId);
                classItem.classList.remove('selected');
            }
            
            updateSelectedCount();
        }

        // æ›´æ–°é€‰æ‹©æ•°é‡æ˜¾ç¤º
        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = selectedClassIds.length;
            }
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const allSelected = selectedClassIds.length === classes.length;
            
            classes.forEach((_, index) => {
                const checkbox = document.getElementById(`class-${index}`);
                const classItem = checkbox.closest('.class-item');
                
                if (allSelected) {
                    // å–æ¶ˆå…¨é€‰
                    checkbox.checked = false;
                    classItem.classList.remove('selected');
                } else {
                    // å…¨é€‰
                    checkbox.checked = true;
                    classItem.classList.add('selected');
                }
            });
            
            if (allSelected) {
                selectedClassIds = [];
            } else {
                selectedClassIds = classes.map((_, index) => index);
            }
            
            updateSelectedCount();
        }

        // é€‰æ‹©å¸¸ç”¨ç±»åˆ«
        function selectCommonClasses() {
            // å¸¸ç”¨ç±»åˆ«åç§°
            const commonClasses = ['person', 'car', 'bicycle', 'motorcycle', 'bus', 'truck', 'dog', 'cat'];
            
            // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
            selectedClassIds = [];
            classes.forEach((_, index) => {
                const checkbox = document.getElementById(`class-${index}`);
                const classItem = checkbox.closest('.class-item');
                checkbox.checked = false;
                classItem.classList.remove('selected');
            });
            
            // é€‰æ‹©å¸¸ç”¨ç±»åˆ«
            classes.forEach((className, index) => {
                if (commonClasses.includes(className.toLowerCase())) {
                    const checkbox = document.getElementById(`class-${index}`);
                    const classItem = checkbox.closest('.class-item');
                    checkbox.checked = true;
                    classItem.classList.add('selected');
                    selectedClassIds.push(index);
                }
            });
            
            updateSelectedCount();
        }

        // å¤„ç†åª’ä½“æ–‡ä»¶ä¸Šä¼ 
        function handleMediaUpload(event) {
            handleMediaFiles(event.target.files);
        }

        function handleMediaFiles(files) {
            if (files.length === 0) return;
            
            showNotification('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'info');
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            fetch(`${API_BASE_URL}/upload_media`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }

                currentSessionId = data.session_id;
                uploadedFiles = data.files;
                currentFileIndex = 0;
                
                // æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
                updateImageList();
                
                // æ›´æ–°æ‰¹é‡å¤„ç†æŒ‰é’®çŠ¶æ€
                updateBatchStatus();
                
                // åŠ è½½ç¬¬ä¸€ä¸ªæ–‡ä»¶
                if (data.files && data.files.length > 0) {
                    loadCurrentFile();
                    
                    // æ˜¾ç¤ºå›¾ç‰‡æµè§ˆå™¨æ§åˆ¶æ ï¼ˆå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼‰
                    if (data.files.length > 1) {
                        showImageBrowser();
                        updateImageBrowserInfo();
                    }
                }
                
                showNotification(`æˆåŠŸä¸Šä¼  ${data.files.length} ä¸ªæ–‡ä»¶`, 'success');
            })
            .catch(error => {
                showNotification('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                console.error('Media upload failed:', error);
            });
        }

        // ä»æœåŠ¡å™¨åŠ è½½å›¾ç‰‡
        function loadImageFromServer(fileInfo) {
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                currentVideo = null;
                
                // éšè—è§†é¢‘æ’­æ”¾å™¨å’Œæ§åˆ¶å™¨
                document.getElementById('videoPlayer').style.display = 'none';
                document.getElementById('videoControls').classList.add('hidden');
                document.getElementById('placeholder').style.display = 'none';
                
                // è°ƒæ•´canvaså¤§å°
                resizeCanvas(img.width, img.height);
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // æ¸…é™¤ä¹‹å‰çš„æ ‡æ³¨
                annotations = [];
                updateAnnotationList();
                updateClassCounts();
                
                document.getElementById('exportBtn').disabled = false;
                showNotification('å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
            };
            
            // ä½¿ç”¨æ–‡ä»¶çš„blob URLæˆ–base64æ•°æ®
            img.src = `/uploads/${fileInfo.unique_filename}`;
        }

        // ä»æœåŠ¡å™¨åŠ è½½è§†é¢‘
        function loadVideoFromServer(fileInfo) {
            const video = document.getElementById('videoPlayer');
            video.src = `/uploads/${fileInfo.unique_filename}`;
            
            // è®¾ç½®è§†é¢‘æ ·å¼ä»¥é€‚åº”å›ºå®šå®¹å™¨
            video.style.display = 'block';
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'contain';
            
            document.getElementById('videoControls').classList.remove('hidden');
            document.getElementById('placeholder').style.display = 'none';
            
            currentVideo = video;
            currentImage = null;
            
            // æ¸…é™¤canvas
            canvas.style.display = 'none';
            
            showNotification('è§†é¢‘åŠ è½½æˆåŠŸ', 'success');
        }

        // åŠ è½½å›¾ç‰‡ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    currentVideo = null;
                    
                    // éšè—è§†é¢‘æ’­æ”¾å™¨å’Œæ§åˆ¶å™¨
                    document.getElementById('videoPlayer').style.display = 'none';
                    document.getElementById('videoControls').classList.add('hidden');
                    document.getElementById('placeholder').style.display = 'none';
                    
                    // è°ƒæ•´canvaså¤§å°
                    resizeCanvas(img.width, img.height);
                    
                    // ç»˜åˆ¶å›¾ç‰‡
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // æ¸…é™¤ä¹‹å‰çš„æ ‡æ³¨
                    annotations = [];
                    updateAnnotationList();
                    
                    document.getElementById('exportBtn').disabled = false;
                    showNotification('å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // åŠ è½½è§†é¢‘
        function loadVideo(file) {
            const video = document.getElementById('videoPlayer');
            const url = URL.createObjectURL(file);
            
            video.src = url;
            video.style.display = 'block';
            document.getElementById('videoControls').classList.remove('hidden');
            document.getElementById('placeholder').style.display = 'none';
            
            currentVideo = video;
            currentImage = null;
            
            // æ¸…é™¤canvas
            canvas.style.display = 'none';
            
            showNotification('è§†é¢‘åŠ è½½æˆåŠŸ', 'success');
        }

        // è°ƒæ•´canvaså¤§å°
        function resizeCanvas(imgWidth, imgHeight) {
            const container = document.querySelector('.canvas-container');
            // ä½¿ç”¨å›ºå®šçš„å®¹å™¨å°ºå¯¸ï¼Œå‡å»è¾¹è·
            const containerWidth = 650 - 40; // å›ºå®šå®½åº¦å‡å»è¾¹è·
            const containerHeight = 650 - 40; // å›ºå®šé«˜åº¦å‡å»è¾¹è·
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å®Œå…¨é€‚åº”å›ºå®šå®¹å™¨
            const scale = Math.min(containerWidth / imgWidth, containerHeight / imgHeight);
            
            // è®¾ç½®canvasçš„å®é™…ç»˜åˆ¶å°ºå¯¸
            canvas.width = imgWidth * scale;
            canvas.height = imgHeight * scale;
            
            // è®¾ç½®canvasçš„CSSæ˜¾ç¤ºæ ·å¼ï¼Œç¡®ä¿åœ¨å›ºå®šå®¹å™¨å†…å±…ä¸­
            canvas.style.display = 'block';
            canvas.style.width = `${imgWidth * scale}px`;
            canvas.style.height = `${imgHeight * scale}px`;
            canvas.style.maxWidth = '610px'; // å›ºå®šæœ€å¤§å®½åº¦
            canvas.style.maxHeight = '610px'; // å›ºå®šæœ€å¤§é«˜åº¦
            canvas.style.objectFit = 'contain';
            canvas.style.margin = 'auto';
            canvas.style.position = 'absolute';
            canvas.style.top = '50%';
            canvas.style.left = '50%';
            canvas.style.transform = 'translate(-50%, -50%)';
        }

        // è‡ªåŠ¨æ ‡æ³¨
        function autoAnnotate() {
            if (!currentModel) {
                showNotification('è¯·å…ˆä¸Šä¼ æ¨¡å‹', 'error');
                return;
            }
            
            if (!currentImage || !currentSessionId || !currentFilename) {
                showNotification('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }

            showNotification('æ­£åœ¨è¿›è¡Œè‡ªåŠ¨æ ‡æ³¨...', 'info');
            
            const confThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
            const iouThreshold = parseFloat(document.getElementById('iouThreshold').value);
            const imgSize = parseInt(document.getElementById('inputSize').value);

            const requestData = {
                session_id: currentSessionId,
                filename: currentFilename,
                conf_threshold: confThreshold,
                iou_threshold: iouThreshold,
                img_size: imgSize,
                selected_classes: selectedClassIds  // ä¼ é€’é€‰æ‹©çš„ç±»åˆ«
            };

            fetch(`${API_BASE_URL}/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }

                // è½¬æ¢APIè¿”å›çš„æ£€æµ‹ç»“æœä¸ºå‰ç«¯æ ¼å¼
                annotations = data.detections.map(det => {
                    const scaleX = canvas.width / data.image_shape[1];
                    const scaleY = canvas.height / data.image_shape[0];
                    
                    const annotation = {
                        id: det.id,
                        class_id: det.class_id,
                        class_name: det.class_name,
                        confidence: det.confidence,
                        bbox: [
                            det.bbox.x1 * scaleX,
                            det.bbox.y1 * scaleY,
                            det.bbox.width * scaleX,
                            det.bbox.height * scaleY
                        ]
                    };
                    
                    // å¦‚æœæœ‰åˆ†å‰²æ•°æ®ï¼Œç¼©æ”¾å¤šè¾¹å½¢åæ ‡
                    if (det.segmentation && det.shape_type === 'polygon') {
                        annotation.segmentation = det.segmentation.map(point => [
                            point[0] * scaleX,
                            point[1] * scaleY
                        ]);
                        annotation.shape_type = 'polygon';
                    } else {
                        annotation.shape_type = 'rectangle';
                    }
                    
                    return annotation;
                });
                
                // æ›´æ–°æ ‡æ³¨çŠ¶æ€
                if (annotations.length > 0) {
                    window.imageAnnotationStatus[currentFilename] = true;
                    updateImageList(); // æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
                }
                
                redrawCanvas();
                updateAnnotationList();
                updateClassCounts();
                
                showNotification(`æ£€æµ‹åˆ° ${annotations.length} ä¸ªç›®æ ‡`, 'success');
            })
            .catch(error => {
                showNotification('è‡ªåŠ¨æ ‡æ³¨å¤±è´¥: ' + error.message, 'error');
                console.error('Auto annotation failed:', error);
            });
        }

        // ä¸€é”®æ£€æµ‹å…¨éƒ¨å›¾ç‰‡ - è‡ªåŠ¨è½®æ’­ç‰ˆæœ¬
        function autoAnnotateAll() {
            if (!currentModel) {
                showNotification('è¯·å…ˆä¸Šä¼ æ¨¡å‹', 'error');
                return;
            }
            
            if (!currentSessionId || !uploadedFiles.length) {
                showNotification('è¯·å…ˆä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            const imageFiles = uploadedFiles.filter(f => f.type === 'image');
            if (imageFiles.length === 0) {
                showNotification('æ²¡æœ‰å¯æ£€æµ‹çš„å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            document.getElementById('autoAnnotateAllBtn').disabled = true;
            
            showNotification(`å¼€å§‹è‡ªåŠ¨è½®æ’­æ£€æµ‹ï¼ˆå…±${imageFiles.length}å¼ ï¼‰...`, 'info');
            
            // å¼€å§‹è‡ªåŠ¨è½®æ’­æ£€æµ‹
            startAutoCarouselDetection(imageFiles);
        }

        // è‡ªåŠ¨è½®æ’­æ£€æµ‹å˜é‡
        let carouselDetectionData = {
            currentIndex: 0,
            imageFiles: [],
            totalDetections: 0,
            classStats: {},
            detectedImages: [],
            emptyImages: [],
            isPaused: false,
            isRunning: false
        };

        // å¼€å§‹è‡ªåŠ¨è½®æ’­æ£€æµ‹
        function startAutoCarouselDetection(imageFiles) {
            // é‡ç½®æ•°æ®
            carouselDetectionData = {
                currentIndex: 0,
                imageFiles: imageFiles,
                totalDetections: 0,
                classStats: {},
                detectedImages: [],
                emptyImages: [],
                isPaused: false,
                isRunning: true
            };

            // æ˜¾ç¤ºæš‚åœæŒ‰é’®ï¼Œéšè—ä¸€é”®æ£€æµ‹æŒ‰é’®
            document.getElementById('autoAnnotateAllBtn').style.display = 'none';
            document.getElementById('pauseResumeBtn').style.display = 'inline-flex';

            // æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
            if (imageFiles.length > 0) {
                const firstImageIndex = uploadedFiles.findIndex(f => f.unique_filename === imageFiles[0].unique_filename);
                if (firstImageIndex >= 0) {
                    currentFileIndex = firstImageIndex;
                    loadCurrentFile();
                    updateImageBrowserInfo();
                }
                
                // å¼€å§‹æ£€æµ‹æµç¨‹
                detectCurrentImageInCarousel();
            }
        }

        // æš‚åœ/ç»§ç»­æ£€æµ‹
        function pauseResumeDetection() {
            const pauseBtn = document.getElementById('pauseResumeBtn');
            
            if (carouselDetectionData.isPaused) {
                // ç»§ç»­æ£€æµ‹
                carouselDetectionData.isPaused = false;
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
                showNotification('ç»§ç»­æ£€æµ‹...', 'info');
                
                // ç»§ç»­æ£€æµ‹å½“å‰å›¾ç‰‡
                detectCurrentImageInCarousel();
            } else {
                // æš‚åœæ£€æµ‹
                carouselDetectionData.isPaused = true;
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
                showNotification('æ£€æµ‹å·²æš‚åœ', 'warning');
            }
        }

        // è½®æ’­æ£€æµ‹å½“å‰å›¾ç‰‡
        function detectCurrentImageInCarousel() {
            const { currentIndex, imageFiles, isPaused, isRunning } = carouselDetectionData;
            
            // æ£€æŸ¥æ˜¯å¦æš‚åœæˆ–åœæ­¢
            if (isPaused || !isRunning) {
                return;
            }
            
            if (currentIndex >= imageFiles.length) {
                // æ£€æµ‹å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœ
                finishCarouselDetection();
                return;
            }

            const currentImageFile = imageFiles[currentIndex];
            const confThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
            const iouThreshold = parseFloat(document.getElementById('iouThreshold').value);
            const imgSize = parseInt(document.getElementById('inputSize').value);

            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯
            const progressPercent = Math.round((currentIndex + 1) / imageFiles.length * 100);
            const currentFile = imageFiles[currentIndex];
            showNotification(`ğŸ” æ£€æµ‹è¿›åº¦: ${currentIndex + 1}/${imageFiles.length} (${progressPercent}%)\nğŸ“„ å½“å‰æ–‡ä»¶: ${currentFile.filename || currentFile.name}`, 'info');

            const requestData = {
                session_id: currentSessionId,
                filename: currentImageFile.unique_filename,
                conf_threshold: confThreshold,
                iou_threshold: iouThreshold,
                img_size: imgSize,
                selected_classes: selectedClassIds
            };

            fetch(`${API_BASE_URL}/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // å†æ¬¡æ£€æŸ¥æ˜¯å¦æš‚åœ
                if (carouselDetectionData.isPaused || !carouselDetectionData.isRunning) {
                    return;
                }

                if (data.error) {
                    console.warn('æ£€æµ‹å¤±è´¥:', data.error);
                    moveToNextImageInCarousel();
                    return;
                }

                // è½¬æ¢æ£€æµ‹ç»“æœ
                annotations = data.detections.map(det => {
                    const scaleX = canvas.width / data.image_shape[1];
                    const scaleY = canvas.height / data.image_shape[0];
                    
                    const annotation = {
                        id: det.id,
                        class_id: det.class_id,
                        class_name: det.class_name,
                        confidence: det.confidence,
                        bbox: [
                            det.bbox.x1 * scaleX,
                            det.bbox.y1 * scaleY,
                            det.bbox.width * scaleX,
                            det.bbox.height * scaleY
                        ]
                    };
                    
                    // å¦‚æœæœ‰åˆ†å‰²æ•°æ®ï¼Œç¼©æ”¾å¤šè¾¹å½¢åæ ‡
                    if (det.segmentation && det.shape_type === 'polygon') {
                        annotation.segmentation = det.segmentation.map(point => [
                            point[0] * scaleX,
                            point[1] * scaleY
                        ]);
                        annotation.shape_type = 'polygon';
                    } else {
                        annotation.shape_type = 'rectangle';
                    }
                    
                    return annotation;
                });

                // æ›´æ–°æ˜¾ç¤º
                redrawCanvas();
                updateAnnotationList();
                updateClassCounts();

                // ç»Ÿè®¡ç»“æœ
                carouselDetectionData.totalDetections += annotations.length;
                if (annotations.length > 0) {
                    carouselDetectionData.detectedImages.push(currentImageFile.filename);
                    annotations.forEach(ann => {
                        const className = ann.class_name;
                        carouselDetectionData.classStats[className] = (carouselDetectionData.classStats[className] || 0) + 1;
                    });
                } else {
                    carouselDetectionData.emptyImages.push(currentImageFile.filename);
                }

                // æ ¹æ®è®¾ç½®çš„å»¶æ—¶åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ ï¼ˆé™¤éæš‚åœï¼‰
                const carouselDelay = parseInt(document.getElementById('carouselDelay')?.value || '300');
                
                if (carouselDelay === 0) {
                    // å³æ—¶åˆ‡æ¢ï¼Œä¸ç­‰å¾…
                    if (!carouselDetectionData.isPaused && carouselDetectionData.isRunning) {
                        moveToNextImageInCarousel();
                    }
                } else {
                    // æŒ‰è®¾å®šæ—¶é—´å»¶æ—¶åˆ‡æ¢
                    setTimeout(() => {
                        if (!carouselDetectionData.isPaused && carouselDetectionData.isRunning) {
                            moveToNextImageInCarousel();
                        }
                    }, carouselDelay);
                }
            })
            .catch(error => {
                console.error('æ£€æµ‹å¤±è´¥:', error);
                // é”™è¯¯æ—¶ä¹ŸæŒ‰ç…§å»¶æ—¶è®¾ç½®è¿›è¡Œåˆ‡æ¢
                const carouselDelay = parseInt(document.getElementById('carouselDelay')?.value || '300');
                
                if (carouselDelay === 0) {
                    moveToNextImageInCarousel();
                } else {
                    setTimeout(() => {
                        if (!carouselDetectionData.isPaused && carouselDetectionData.isRunning) {
                            moveToNextImageInCarousel();
                        }
                    }, Math.min(carouselDelay, 500)); // é”™è¯¯æ—¶æœ€å¤šç­‰å¾…0.5ç§’
                }
            });
        }

        // ç§»åŠ¨åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
        function moveToNextImageInCarousel() {
            carouselDetectionData.currentIndex++;
            
            if (carouselDetectionData.currentIndex < carouselDetectionData.imageFiles.length) {
                // åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
                const nextImageFile = carouselDetectionData.imageFiles[carouselDetectionData.currentIndex];
                const nextImageIndex = uploadedFiles.findIndex(f => f.unique_filename === nextImageFile.unique_filename);
                
                if (nextImageIndex >= 0) {
                    currentFileIndex = nextImageIndex;
                    loadCurrentFile();
                    updateImageBrowserInfo();
                    
                    // ç­‰å¾…å›¾ç‰‡åŠ è½½åç»§ç»­æ£€æµ‹ï¼ˆå‡å°‘ç­‰å¾…æ—¶é—´ï¼‰
                    setTimeout(() => {
                        detectCurrentImageInCarousel();
                    }, 200);
                }
            } else {
                // æ£€æµ‹å®Œæˆ
                finishCarouselDetection();
            }
        }

        // å®Œæˆè½®æ’­æ£€æµ‹
        function finishCarouselDetection() {
            const { totalDetections, classStats, detectedImages, emptyImages, imageFiles } = carouselDetectionData;
            
            // åœæ­¢æ£€æµ‹çŠ¶æ€
            carouselDetectionData.isRunning = false;
            carouselDetectionData.isPaused = false;

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            document.getElementById('autoAnnotateAllBtn').style.display = 'inline-flex';
            document.getElementById('autoAnnotateAllBtn').disabled = false;
            document.getElementById('pauseResumeBtn').style.display = 'none';
            
            // æ„å»ºç»“æœæ¶ˆæ¯
            let resultMessage = `ğŸ‰ è½®æ’­æ£€æµ‹å®Œæˆï¼\n`;
            resultMessage += `ğŸ“Š å…±å¤„ç† ${imageFiles.length} å¼ å›¾ç‰‡\n`;
            resultMessage += `âœ… æ£€æµ‹åˆ° ${totalDetections} ä¸ªç›®æ ‡\n`;
            resultMessage += `ğŸ“ˆ æœ‰ç›®æ ‡çš„å›¾ç‰‡: ${detectedImages.length} å¼ \n`;
            resultMessage += `ğŸ“‹ æ— ç›®æ ‡çš„å›¾ç‰‡: ${emptyImages.length} å¼ `;

            if (Object.keys(classStats).length > 0) {
                const classStatsStr = Object.entries(classStats)
                    .map(([cls, count]) => `${cls}: ${count}ä¸ª`)
                    .join(', ');
                resultMessage += `\nğŸ·ï¸ æ£€æµ‹è¯¦æƒ…: ${classStatsStr}`;
            }

            showNotification(resultMessage, 'success');
            
            // æ›´æ–°å³ä¾§ç»Ÿè®¡æ˜¾ç¤º
            updateDetectionStatistics(carouselDetectionData);
            
            // åœç•™åœ¨æœ€åä¸€å¼ æœ‰æ£€æµ‹ç»“æœçš„å›¾ç‰‡
            if (detectedImages.length > 0) {
                const lastDetectedFile = detectedImages[detectedImages.length - 1];
                const lastDetectedIndex = uploadedFiles.findIndex(f => f.filename === lastDetectedFile);
                if (lastDetectedIndex >= 0) {
                    currentFileIndex = lastDetectedIndex;
                    loadCurrentFile();
                    updateImageBrowserInfo();
                }
            }
        }

        // æ›´æ–°æ£€æµ‹ç»Ÿè®¡æ˜¾ç¤º
        function updateDetectionStatistics(data) {
            const statisticsDiv = document.getElementById('detectionStatistics');
            const statisticsContent = document.getElementById('statisticsContent');
            
            if (!data || data.totalDetections === 0) {
                statisticsDiv.style.display = 'none';
                return;
            }

            let content = '';
            content += `<div style="margin-bottom: 8px;"><strong>ğŸ“Š æ£€æµ‹æ€»è§ˆ</strong></div>`;
            content += `<div style="margin-bottom: 6px;">â€¢ å¤„ç†å›¾ç‰‡: <span style="color: #4299e1;">${data.imageFiles.length} å¼ </span></div>`;
            content += `<div style="margin-bottom: 6px;">â€¢ æ£€æµ‹ç›®æ ‡: <span style="color: #48bb78;">${data.totalDetections} ä¸ª</span></div>`;
            content += `<div style="margin-bottom: 6px;">â€¢ æœ‰ç›®æ ‡å›¾ç‰‡: <span style="color: #ed8936;">${data.detectedImages.length} å¼ </span></div>`;
            content += `<div style="margin-bottom: 10px;">â€¢ æ— ç›®æ ‡å›¾ç‰‡: <span style="color: #a0aec0;">${data.emptyImages.length} å¼ </span></div>`;

            if (Object.keys(data.classStats).length > 0) {
                content += `<div style="margin-bottom: 6px;"><strong>ğŸ·ï¸ ç±»åˆ«è¯¦æƒ…</strong></div>`;
                Object.entries(data.classStats).forEach(([className, count]) => {
                    content += `<div style="margin-bottom: 4px; margin-left: 8px;">â€¢ ${className}: <span style="color: #667eea;">${count} ä¸ª</span></div>`;
                });
            }

            statisticsContent.innerHTML = content;
            statisticsDiv.style.display = 'block';
        }

        // åŠ è½½å½“å‰å›¾ç‰‡çš„é¢„æµ‹ç»“æœ
        function loadPredictionForCurrentImage() {
            if (!currentModel || !currentSessionId || !currentFilename) {
                return;
            }

            const confThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
            const iouThreshold = parseFloat(document.getElementById('iouThreshold').value);
            const imgSize = parseInt(document.getElementById('inputSize').value);

            const requestData = {
                session_id: currentSessionId,
                filename: currentFilename,
                conf_threshold: confThreshold,
                iou_threshold: iouThreshold,
                img_size: imgSize,
                selected_classes: selectedClassIds
            };

            fetch(`${API_BASE_URL}/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.warn('åŠ è½½é¢„æµ‹ç»“æœå¤±è´¥:', data.error);
                    return;
                }

                // è½¬æ¢APIè¿”å›çš„æ£€æµ‹ç»“æœä¸ºå‰ç«¯æ ¼å¼
                annotations = data.detections.map(det => {
                    const scaleX = canvas.width / data.image_shape[1];
                    const scaleY = canvas.height / data.image_shape[0];
                    
                    const annotation = {
                        id: det.id,
                        class_id: det.class_id,
                        class_name: det.class_name,
                        confidence: det.confidence,
                        bbox: [
                            det.bbox.x1 * scaleX,
                            det.bbox.y1 * scaleY,
                            det.bbox.width * scaleX,
                            det.bbox.height * scaleY
                        ]
                    };
                    
                    // å¦‚æœæœ‰åˆ†å‰²æ•°æ®ï¼Œç¼©æ”¾å¤šè¾¹å½¢åæ ‡
                    if (det.segmentation && det.shape_type === 'polygon') {
                        annotation.segmentation = det.segmentation.map(point => [
                            point[0] * scaleX,
                            point[1] * scaleY
                        ]);
                        annotation.shape_type = 'polygon';
                    } else {
                        annotation.shape_type = 'rectangle';
                    }
                    
                    return annotation;
                });
                
                redrawCanvas();
                updateAnnotationList();
                updateClassCounts();
            })
            .catch(error => {
                console.warn('åŠ è½½é¢„æµ‹ç»“æœå¤±è´¥:', error);
            });
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ ‡æ³¨æ•°æ®
        function generateMockAnnotations() {
            const mockData = [];
            const numObjects = Math.floor(Math.random() * 8) + 2;
            
            for (let i = 0; i < numObjects; i++) {
                const classIndex = Math.floor(Math.random() * currentModel.classes.length);
                const confidence = 0.5 + Math.random() * 0.4;
                
                const x = Math.random() * (canvas.width - 100);
                const y = Math.random() * (canvas.height - 100);
                const width = 50 + Math.random() * 150;
                const height = 50 + Math.random() * 150;
                
                mockData.push({
                    id: Date.now() + i,
                    class_id: classIndex,
                    class_name: currentModel.classes[classIndex],
                    confidence: confidence,
                    bbox: [x, y, width, height]
                });
            }
            
            return mockData;
        }

        // é‡ç»˜canvas
        function redrawCanvas() {
            if (!currentImage) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ ‡æ³¨
            annotations.forEach((annotation, index) => {
                const color = colors[annotation.class_id % colors.length];
                
                if (annotation.segmentation && annotation.shape_type === 'polygon') {
                    // ç»˜åˆ¶å¤šè¾¹å½¢
                    const points = annotation.segmentation;
                    if (points && points.length >= 3) {
                        ctx.beginPath();
                        ctx.moveTo(points[0][0], points[0][1]);
                        for (let i = 1; i < points.length; i++) {
                            ctx.lineTo(points[i][0], points[i][1]);
                        }
                        ctx.closePath();
                        
                        // å¡«å……åŠé€æ˜é¢œè‰²
                        ctx.fillStyle = color + '40';  // æ·»åŠ é€æ˜åº¦
                        ctx.fill();
                        
                        // ç»˜åˆ¶è¾¹æ¡†
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // ç»˜åˆ¶é¡¶ç‚¹
                        points.forEach(point => {
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(point[0], point[1], 4, 0, 2 * Math.PI);
                            ctx.fill();
                        });
                        
                        // ç»˜åˆ¶æ ‡ç­¾ï¼ˆåœ¨å¤šè¾¹å½¢é¡¶éƒ¨ï¼‰
                        const minY = Math.min(...points.map(p => p[1]));
                        const minX = Math.min(...points.map(p => p[0]));
                        const label = `${annotation.class_name} ${(annotation.confidence * 100).toFixed(1)}%`;
                        const textWidth = ctx.measureText(label).width;
                        
                        ctx.fillStyle = color;
                        ctx.fillRect(minX, minY - 25, textWidth + 10, 25);
                        ctx.fillStyle = 'white';
                        ctx.font = '14px Arial';
                        ctx.fillText(label, minX + 5, minY - 8);
                    }
                } else {
                    // ç»˜åˆ¶çŸ©å½¢è¾¹ç•Œæ¡†
                    const [x, y, width, height] = annotation.bbox;
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, width, height);
                    
                    // ç»˜åˆ¶æ ‡ç­¾
                    const label = `${annotation.class_name} ${(annotation.confidence * 100).toFixed(1)}%`;
                    const textWidth = ctx.measureText(label).width;
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(x, y - 25, textWidth + 10, 25);
                    ctx.fillStyle = 'white';
                    ctx.font = '14px Arial';
                    ctx.fillText(label, x + 5, y - 8);
                }
            });
            
            // ç»˜åˆ¶å½“å‰æ­£åœ¨ç»˜åˆ¶çš„å¤šè¾¹å½¢
            if (isDrawingPolygon && polygonPoints.length > 0) {
                ctx.strokeStyle = '#667eea';
                ctx.fillStyle = '#667eea40';
                ctx.lineWidth = 2;
                
                // ç»˜åˆ¶å·²æœ‰çš„çº¿æ®µ
                ctx.beginPath();
                ctx.moveTo(polygonPoints[0][0], polygonPoints[0][1]);
                for (let i = 1; i < polygonPoints.length; i++) {
                    ctx.lineTo(polygonPoints[i][0], polygonPoints[i][1]);
                }
                
                // å¦‚æœæœ‰è‡³å°‘3ä¸ªç‚¹ï¼Œæ˜¾ç¤ºé—­åˆæ•ˆæœ
                if (polygonPoints.length >= 3) {
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.stroke();
                
                // ç»˜åˆ¶é¡¶ç‚¹
                polygonPoints.forEach(point => {
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(point[0], point[1], 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }
        }

        // æ›´æ–°æ ‡æ³¨åˆ—è¡¨
        function updateAnnotationList() {
            const annotationList = document.getElementById('annotationList');
            
            if (annotations.length === 0) {
                annotationList.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">æš‚æ— æ ‡æ³¨</p>';
                return;
            }
            
            annotationList.innerHTML = '';
            
            annotations.forEach((annotation, index) => {
                const item = document.createElement('div');
                item.className = 'annotation-item';
                item.innerHTML = `
                    <div class="annotation-details">
                        <div class="annotation-class">${annotation.class_name}</div>
                        <div class="annotation-confidence">ç½®ä¿¡åº¦: ${(annotation.confidence * 100).toFixed(1)}%</div>
                    </div>
                    <div class="annotation-actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteAnnotation(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                annotationList.appendChild(item);
            });
        }

        // æ›´æ–°ç±»åˆ«è®¡æ•°
        function updateClassCounts() {
            // é‡ç½®è®¡æ•°
            currentModel.classes.forEach((_, index) => {
                const countElement = document.getElementById(`count-${index}`);
                if (countElement) countElement.textContent = '0';
            });
            
            // ç»Ÿè®¡æ¯ä¸ªç±»åˆ«çš„æ•°é‡
            const counts = {};
            annotations.forEach(annotation => {
                counts[annotation.class_id] = (counts[annotation.class_id] || 0) + 1;
            });
            
            // æ›´æ–°æ˜¾ç¤º
            Object.keys(counts).forEach(classId => {
                const countElement = document.getElementById(`count-${classId}`);
                if (countElement) countElement.textContent = counts[classId];
            });
        }

        // åˆ é™¤æ ‡æ³¨
        function deleteAnnotation(index) {
            annotations.splice(index, 1);
            redrawCanvas();
            updateAnnotationList();
            updateClassCounts();
            
            // åˆ é™¤æ ‡æ³¨åè‡ªåŠ¨ä¿å­˜
            setTimeout(autoSaveProgress, 500);
        }

        // æ¸…é™¤å½“å‰æ ‡æ³¨
        function clearAnnotations() {
            annotations = [];
            redrawCanvas();
            updateAnnotationList();
            updateClassCounts();
            showNotification('å½“å‰æ ‡æ³¨å·²æ¸…é™¤', 'success');
        }

        // æ¸…é™¤å…¨éƒ¨æ ‡æ³¨
        function clearAllAnnotations() {
            if (!currentSessionId) {
                showNotification('è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ–‡ä»¶çš„æ ‡æ³¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                fetch(`${API_BASE_URL}/clear_all_annotations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'error');
                        return;
                    }

                    // æ¸…é™¤å½“å‰ç•Œé¢çš„æ ‡æ³¨
                    annotations = [];
                    redrawCanvas();
                    updateAnnotationList();
                    updateClassCounts();
                    
                    showNotification('æ‰€æœ‰æ ‡æ³¨æ•°æ®å·²æ¸…é™¤', 'success');
                })
                .catch(error => {
                    showNotification('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
                    console.error('Clear all annotations failed:', error);
                });
            }
        }

        // åˆ é™¤å½“å‰æ–‡ä»¶
        function deleteCurrentFile() {
            if (!currentSessionId || !currentFilename) {
                showNotification('æ²¡æœ‰å¯åˆ é™¤çš„æ–‡ä»¶', 'error');
                return;
            }

            const currentFile = uploadedFiles[currentFileIndex];
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${currentFile.filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                fetch(`${API_BASE_URL}/delete_file`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        filename: currentFilename
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'error');
                        return;
                    }

                    // ä»æœ¬åœ°æ–‡ä»¶åˆ—è¡¨ä¸­ç§»é™¤
                    uploadedFiles.splice(currentFileIndex, 1);

                    // å¦‚æœè¿˜æœ‰å…¶ä»–æ–‡ä»¶ï¼Œåˆ‡æ¢åˆ°ç›¸é‚»æ–‡ä»¶
                    if (uploadedFiles.length > 0) {
                        // è°ƒæ•´å½“å‰ç´¢å¼•
                        if (currentFileIndex >= uploadedFiles.length) {
                            currentFileIndex = uploadedFiles.length - 1;
                        }
                        loadCurrentFile();
                        updateImageBrowserInfo();
                    } else {
                        // æ²¡æœ‰æ–‡ä»¶äº†ï¼Œé‡ç½®ç•Œé¢
                        currentFilename = null;
                        currentFileIndex = 0;
                        uploadedFiles = [];
                        hideImageBrowser();
                        
                        // æ˜¾ç¤ºå ä½ç¬¦
                        const canvas = document.getElementById('annotationCanvas');
                        const video = document.getElementById('videoPlayer');
                        const placeholder = document.getElementById('placeholder');
                        
                        canvas.style.display = 'none';
                        video.style.display = 'none';
                        placeholder.style.display = 'block';
                        
                        // éšè—è§†é¢‘æ§åˆ¶
                        document.getElementById('videoControls').classList.add('hidden');
                        
                        // æ¸…é™¤æ ‡æ³¨
                        annotations = [];
                        updateAnnotationList();
                        updateClassCounts();
                    }

                    showNotification(`æ–‡ä»¶ "${currentFile.filename}" å·²åˆ é™¤`, 'success');
                })
                .catch(error => {
                    showNotification('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    console.error('Delete file failed:', error);
                });
            }
        }

        // å¯¼å‡ºæ ‡æ³¨æ•°æ®
        function exportAnnotations() {
            if (annotations.length === 0) {
                showNotification('æ²¡æœ‰æ ‡æ³¨æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }

            if (!currentSessionId || !currentFilename) {
                showNotification('ç¼ºå°‘ä¼šè¯ä¿¡æ¯', 'error');
                return;
            }

            const format = document.getElementById('exportFormat').value;
            
            showNotification('æ­£åœ¨å¯¼å‡ºæ ‡æ³¨æ•°æ®...', 'info');

            // è½¬æ¢å‰ç«¯æ ‡æ³¨æ ¼å¼ä¸ºAPIæ ¼å¼
            const apiAnnotations = annotations.map(ann => {
                const annotation = {
                    id: ann.id,
                    class_id: ann.class_id,
                    class_name: ann.class_name,
                    confidence: ann.confidence,
                    bbox: {
                        x1: ann.bbox[0],
                        y1: ann.bbox[1],
                        x2: ann.bbox[0] + ann.bbox[2],
                        y2: ann.bbox[1] + ann.bbox[3],
                        width: ann.bbox[2],
                        height: ann.bbox[3]
                    }
                };
                
                // å¦‚æœæ˜¯å¤šè¾¹å½¢æ ‡æ³¨ï¼Œæ·»åŠ segmentationå’Œshape_type
                if (ann.segmentation && ann.shape_type === 'polygon') {
                    annotation.segmentation = ann.segmentation;
                    annotation.shape_type = 'polygon';
                } else {
                    annotation.shape_type = 'rectangle';
                }
                
                return annotation;
            });

            const requestData = {
                session_id: currentSessionId,
                filename: currentFilename,
                format: format,
                annotations: apiAnnotations
            };

            fetch(`${API_BASE_URL}/export_annotations`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `annotations_${format}_${Date.now()}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('æ ‡æ³¨æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            })
            .catch(error => {
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                console.error('Export failed:', error);
            });
        }

        // åˆ é™¤å…¨éƒ¨æ–‡ä»¶
        function deleteAllFiles() {
            if (!uploadedFiles || uploadedFiles.length === 0) {
                showNotification('æ²¡æœ‰æ–‡ä»¶å¯åˆ é™¤', 'warning');
                return;
            }

            // ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…¨éƒ¨ ${uploadedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            // æ¸…ç†å‰ç«¯çŠ¶æ€
            currentImage = null;
            currentVideo = null;
            currentFilename = null;
            currentFileIndex = 0;
            annotations = [];
            
            // éšè—æ˜¾ç¤ºå…ƒç´ 
            document.getElementById('annotationCanvas').style.display = 'none';
            document.getElementById('videoPlayer').style.display = 'none';
            document.getElementById('placeholder').style.display = 'block';
            document.getElementById('videoControls').style.display = 'none';
            
            // æ¸…ç©ºç”»å¸ƒ
            if (canvas && ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // æ›´æ–°UI
            updateAnnotationList();
            updateClassCounts();
            hideImageBrowser();
            
            // æ¸…é™¤æ£€æµ‹ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('detectionStatistics').style.display = 'none';
            
            // å¦‚æœæœ‰ä¼šè¯IDï¼Œè°ƒç”¨åç«¯æ¸…ç†
            if (currentSessionId) {
                fetch(`${API_BASE_URL}/clear_session/${currentSessionId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.warn('åç«¯æ¸…ç†å¤±è´¥:', data.error);
                    } else {
                        console.log('åç«¯æ–‡ä»¶æ¸…ç†å®Œæˆ');
                    }
                })
                .catch(error => {
                    console.warn('åç«¯æ¸…ç†å¤±è´¥:', error);
                });
            }
            
            // æ¸…ç©ºæ–‡ä»¶æ•°ç»„
            uploadedFiles = [];
            currentSessionId = null;
            
            showNotification('å·²åˆ é™¤å…¨éƒ¨æ–‡ä»¶å’ŒæœåŠ¡å™¨æ•°æ®', 'success');
        }

        // å›¾ç‰‡æµè§ˆå™¨åŠŸèƒ½
        function loadCurrentFile() {
            if (!uploadedFiles || uploadedFiles.length === 0) return;
            
            const currentFile = uploadedFiles[currentFileIndex];
            currentFilename = currentFile.unique_filename;
            
            if (currentFile.type === 'image') {
                loadImageFromServer(currentFile);
                
                // å»¶è¿ŸåŠ è½½é¢„æµ‹ç»“æœï¼Œç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                setTimeout(() => {
                    if (currentModel && currentSessionId && currentFilename) {
                        loadPredictionForCurrentImage();
                    }
                }, 500); // 500mså»¶è¿Ÿç¡®ä¿å›¾ç‰‡å·²åŠ è½½
            } else if (currentFile.type === 'video') {
                loadVideoFromServer(currentFile);
                // æ¸…é™¤è§†é¢‘çš„æ ‡æ³¨
                annotations = [];
                updateAnnotationList();
                updateClassCounts();
            }
            
            // æ–‡ä»¶åˆ‡æ¢åè‡ªåŠ¨ä¿å­˜å½“å‰çŠ¶æ€
            setTimeout(autoSaveProgress, 1000);
        }

        function showImageBrowser() {
            document.getElementById('imageBrowserControls').style.display = 'block';
        }

        function hideImageBrowser() {
            document.getElementById('imageBrowserControls').style.display = 'none';
        }

        function updateImageBrowserInfo() {
            if (!uploadedFiles || uploadedFiles.length === 0) return;
            
            const imageInfo = document.getElementById('imageInfo');
            const imageProgress = document.getElementById('imageProgress');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const autoAnnotateAllBtn = document.getElementById('autoAnnotateAllBtn');
            
            const currentFile = uploadedFiles[currentFileIndex];
            imageInfo.textContent = `${currentFile.filename} (${currentFileIndex + 1}/${uploadedFiles.length})`;
            
            const progress = ((currentFileIndex + 1) / uploadedFiles.length) * 100;
            imageProgress.style.width = progress + '%';
            
            prevBtn.disabled = currentFileIndex === 0;
            nextBtn.disabled = currentFileIndex === uploadedFiles.length - 1;
            
            // å¯ç”¨ä¸€é”®æ£€æµ‹å…¨éƒ¨æŒ‰é’®ï¼ˆå¦‚æœæœ‰æ¨¡å‹å’Œå›¾ç‰‡æ–‡ä»¶ï¼‰
            const imageFiles = uploadedFiles.filter(f => f.type === 'image');
            autoAnnotateAllBtn.disabled = !currentModel || imageFiles.length === 0;
        }

        function previousImage() {
            if (currentFileIndex > 0) {
                currentFileIndex--;
                loadCurrentFile();
                updateImageBrowserInfo();
                updateImageList(); // æ›´æ–°å›¾ç‰‡åˆ—è¡¨çš„activeçŠ¶æ€
            }
        }

        function nextImage() {
            if (currentFileIndex < uploadedFiles.length - 1) {
                currentFileIndex++;
                loadCurrentFile();
                updateImageBrowserInfo();
                updateImageList(); // æ›´æ–°å›¾ç‰‡åˆ—è¡¨çš„activeçŠ¶æ€
            }
        }

        // æ›´æ–°æ‰¹é‡çŠ¶æ€
        function updateBatchStatus() {
            const batchStatus = document.getElementById('batchStatus');
            const batchProcessBtn = document.getElementById('batchProcessBtn');
            
            if (currentSessionId) {
                batchStatus.textContent = 'å·²å‡†å¤‡å¥½æ‰¹é‡å¤„ç†';
                batchProcessBtn.disabled = !currentModel;
            } else {
                batchStatus.textContent = 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶';
                batchProcessBtn.disabled = true;
            }
        }

        // æ‰¹é‡å¤„ç†ç›¸å…³å‡½æ•°
        function selectBatchFiles() {
            document.getElementById('batchFiles').click();
        }
        
        function selectBatchFolder() {
            document.getElementById('batchFolder').click();
        }

        function handleBatchFiles(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                // è¿‡æ»¤å‡ºå›¾ç‰‡å’Œè§†é¢‘æ–‡ä»¶
                const mediaFiles = Array.from(files).filter(file => {
                    const isImage = file.type.startsWith('image/');
                    const isVideo = file.type.startsWith('video/');
                    return isImage || isVideo;
                });
                
                if (mediaFiles.length === 0) {
                    showNotification('æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶', 'error');
                    return;
                }
                
                // åˆ›å»ºä¸€ä¸ªæ–°çš„FileListå¯¹è±¡ï¼ˆå®é™…ä¸Šæˆ‘ä»¬ä¼ é€’æ•°ç»„ï¼‰
                handleMediaFiles(mediaFiles);
                
                // æ˜¾ç¤ºæç¤º
                if (mediaFiles.length < files.length) {
                    const skipped = files.length - mediaFiles.length;
                    showNotification(`å·²è¿‡æ»¤ ${skipped} ä¸ªéåª’ä½“æ–‡ä»¶ï¼Œé€‰æ‹©äº† ${mediaFiles.length} ä¸ªæœ‰æ•ˆæ–‡ä»¶`, 'info');
                }
            }
            
            // é‡ç½®inputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶å¤¹
            event.target.value = '';
        }

        function processBatch() {
            if (!currentModel || !currentSessionId) {
                showNotification('è¯·å…ˆä¸Šä¼ æ¨¡å‹å’Œæ–‡ä»¶', 'error');
                return;
            }
            
            // è·å–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
            const imageFiles = uploadedFiles.filter(f => f.type === 'image');
            
            if (imageFiles.length === 0) {
                showNotification('æ²¡æœ‰å¯æ£€æµ‹çš„å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
            batchProcessStats = {
                processed: 0,
                detected: 0,
                empty: 0,
                total: imageFiles.length
            };
            
            showNotification('å¼€å§‹æ‰¹é‡æ£€æµ‹...', 'info');
            showBatchStats();
            updateBatchProgress(0);
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            const batchBtn = document.getElementById('batchProcessBtn');
            batchBtn.disabled = true;
            
            // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»ï¼ˆæ¨¡æ‹Ÿè¿›åº¦ï¼‰
            let simulatedProgress = 0;
            const progressInterval = setInterval(() => {
                if (simulatedProgress < 90) {
                    // å¹³æ»‘å¢é•¿åˆ°90%
                    simulatedProgress += Math.random() * 3;
                    if (simulatedProgress > 90) simulatedProgress = 90;
                    updateBatchProgress(simulatedProgress);
                    
                    // ä¼°ç®—å½“å‰å¤„ç†æ•°é‡
                    const estimatedProcessed = Math.floor((simulatedProgress / 100) * imageFiles.length);
                    document.getElementById('batchStatus').textContent = 
                        `æ­£åœ¨æ‰¹é‡æ£€æµ‹... é¢„è®¡å¤„ç†: ${estimatedProcessed}/${imageFiles.length}`;
                }
            }, 100);
            
            const confThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
            const iouThreshold = parseFloat(document.getElementById('iouThreshold').value);
            const imgSize = parseInt(document.getElementById('inputSize').value);

            const requestData = {
                session_id: currentSessionId,
                conf_threshold: confThreshold,
                iou_threshold: iouThreshold,
                img_size: imgSize,
                selected_classes: selectedClassIds
            };

            fetch(`${API_BASE_URL}/batch_predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // åœæ­¢è¿›åº¦åŠ¨ç”»
                clearInterval(progressInterval);
                
                if (data.error) {
                    showNotification(data.error, 'error');
                    batchBtn.disabled = false;
                    return;
                }

                // ç»Ÿè®¡ç»“æœå¹¶æ›´æ–°æ ‡æ³¨çŠ¶æ€
                batchProcessStats.processed = data.results.length;
                batchProcessStats.detected = data.results.filter(r => r.count > 0).length;
                batchProcessStats.empty = data.results.filter(r => r.count === 0).length;
                
                // æ›´æ–°æ¯ä¸ªæ–‡ä»¶çš„æ ‡æ³¨çŠ¶æ€
                data.results.forEach(result => {
                    if (result.count > 0) {
                        window.imageAnnotationStatus[result.unique_filename] = true;
                    }
                });

                // å¿«é€Ÿå®Œæˆè¿›åº¦æ¡
                updateBatchProgress(100);
                updateBatchStatsDisplay();
                
                // æ›´æ–°å›¾ç‰‡åˆ—è¡¨çš„æ ‡æ³¨çŠ¶æ€
                updateImageList();
                
                const totalDetections = data.results.reduce((sum, result) => sum + result.count, 0);
                
                document.getElementById('batchStatus').textContent = 
                    `å®Œæˆï¼å¤„ç†äº† ${data.results.length} ä¸ªæ–‡ä»¶ï¼Œæ£€æµ‹åˆ° ${totalDetections} ä¸ªç›®æ ‡`;
                
                showNotification(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼æœ‰ ${batchProcessStats.empty} å¼ å›¾ç‰‡æœªæ£€æµ‹åˆ°ç›®æ ‡`, 'success');
                
                // åˆ·æ–°å½“å‰å›¾ç‰‡çš„æ ‡æ³¨æ˜¾ç¤º
                if (currentFileIndex >= 0 && currentFileIndex < uploadedFiles.length) {
                    loadCurrentFile();
                }
                
                // é‡æ–°å¯ç”¨æŒ‰é’®
                batchBtn.disabled = false;
                
                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                setTimeout(() => {
                    showNotification(`æ€»å…±æ£€æµ‹åˆ° ${totalDetections} ä¸ªç›®æ ‡`, 'info');
                }, 1000);
            })
            .catch(error => {
                // åœæ­¢è¿›åº¦åŠ¨ç”»
                clearInterval(progressInterval);
                batchBtn.disabled = false;
                showNotification('æ‰¹é‡å¤„ç†å¤±è´¥: ' + error.message, 'error');
                console.error('Batch processing failed:', error);
            });
        }

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†ç»Ÿè®¡ä¿¡æ¯
        function showBatchStats() {
            document.getElementById('batchStats').style.display = 'block';
            updateBatchStatsDisplay();
        }

        // æ›´æ–°æ‰¹é‡å¤„ç†è¿›åº¦
        function updateBatchProgress(percentage) {
            document.getElementById('batchProgress').style.width = percentage + '%';
            document.getElementById('batchPercentage').textContent = Math.round(percentage) + '%';
        }

        // æ›´æ–°æ‰¹é‡å¤„ç†ç»Ÿè®¡æ˜¾ç¤º
        function updateBatchStatsDisplay() {
            document.getElementById('processedCount').textContent = batchProcessStats.processed;
            document.getElementById('detectedCount').textContent = batchProcessStats.detected;
            document.getElementById('remainingCount').textContent = batchProcessStats.total - batchProcessStats.processed;
            document.getElementById('emptyCount').textContent = batchProcessStats.empty;
        }
        
        // æ›´æ–°å›¾ç‰‡åˆ—è¡¨
        function updateImageList() {
            const imageListSection = document.getElementById('imageListSection');
            const imageListContainer = document.getElementById('imageListContainer');
            const imageListCount = document.getElementById('imageListCount');
            
            // åªæ˜¾ç¤ºå›¾ç‰‡æ–‡ä»¶
            const imageFiles = uploadedFiles.filter(f => f.type === 'image');
            
            if (imageFiles.length === 0) {
                imageListSection.style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨åŒºåŸŸ
            imageListSection.style.display = 'block';
            imageListCount.textContent = `${imageFiles.length}å¼ `;
            
            // æ¸…ç©ºåˆ—è¡¨
            imageListContainer.innerHTML = '';
            
            // ä¸ºæ¯ä¸ªå›¾ç‰‡æ–‡ä»¶åˆ›å»ºåˆ—è¡¨é¡¹
            imageFiles.forEach((fileInfo, index) => {
                // æ‰¾åˆ°è¯¥æ–‡ä»¶åœ¨uploadedFilesä¸­çš„çœŸå®ç´¢å¼•
                const realIndex = uploadedFiles.indexOf(fileInfo);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡æ³¨æ•°æ®
                const hasAnnotations = checkImageHasAnnotations(fileInfo.unique_filename);
                
                const listItem = document.createElement('div');
                listItem.className = 'image-list-item';
                if (realIndex === currentFileIndex) {
                    listItem.classList.add('active');
                }
                if (hasAnnotations) {
                    listItem.classList.add('annotated');
                }
                
                listItem.innerHTML = `
                    <div class="image-status-icon${hasAnnotations ? ' annotated' : ''}">
                        ${hasAnnotations ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="image-list-filename" title="${fileInfo.filename}">${fileInfo.filename}</div>
                `;
                
                // ç‚¹å‡»è·³è½¬åˆ°è¯¥å›¾ç‰‡
                listItem.addEventListener('click', () => {
                    jumpToImage(realIndex);
                });
                
                imageListContainer.appendChild(listItem);
            });
        }
        
        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰æ ‡æ³¨æ•°æ®ï¼ˆä»æœåŠ¡å™¨ç¼“å­˜ï¼‰
        function checkImageHasAnnotations(uniqueFilename) {
            // è¿™é‡Œéœ€è¦é€šè¿‡æŸç§æ–¹å¼æ£€æŸ¥æœåŠ¡å™¨ä¸Šæ˜¯å¦æœ‰è¯¥å›¾ç‰‡çš„é¢„æµ‹ç»“æœ
            // æš‚æ—¶ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼šå‡è®¾å¦‚æœæ‰¹é‡å¤„ç†åï¼Œå°±ä¼šæœ‰æ•°æ®
            // å®é™…ä½¿ç”¨ä¸­å¯ä»¥é€šè¿‡ä¸€ä¸ªå…¨å±€å¯¹è±¡å­˜å‚¨æ¯ä¸ªæ–‡ä»¶çš„æ ‡æ³¨çŠ¶æ€
            return window.imageAnnotationStatus && window.imageAnnotationStatus[uniqueFilename];
        }
        
        // è·³è½¬åˆ°æŒ‡å®šç´¢å¼•çš„å›¾ç‰‡
        function jumpToImage(index) {
            if (index < 0 || index >= uploadedFiles.length) {
                return;
            }
            
            // å¦‚æœæ˜¯è§†é¢‘æ–‡ä»¶ï¼Œè·³è¿‡
            if (uploadedFiles[index].type !== 'image') {
                showNotification('åªèƒ½æŸ¥çœ‹å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            currentFileIndex = index;
            loadCurrentFile();
            updateImageBrowserInfo();
            updateImageList(); // æ›´æ–°activeçŠ¶æ€
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡æ ‡æ³¨çŠ¶æ€è¿½è¸ª
        if (!window.imageAnnotationStatus) {
            window.imageAnnotationStatus = {};
        }

        // è§†é¢‘ç›¸å…³å‡½æ•°
        function updateVideoTime() {
            const video = document.getElementById('videoPlayer');
            const currentTime = document.getElementById('currentTime');
            
            const minutes = Math.floor(video.currentTime / 60);
            const seconds = Math.floor(video.currentTime % 60);
            currentTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function extractFrame() {
            if (!currentVideo) return;
            
            const video = currentVideo;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCtx.drawImage(video, 0, 0);
            
            // å°†æå–çš„å¸§è½¬æ¢ä¸ºå›¾ç‰‡
            tempCanvas.toBlob(blob => {
                const file = new File([blob], `frame_${video.currentTime.toFixed(2)}s.jpg`, { type: 'image/jpeg' });
                loadImage(file);
            });
            
            showNotification('å¸§æå–æˆåŠŸ', 'success');
        }

        // æ˜¾ç¤ºè§†é¢‘å¸§æå–å¯¹è¯æ¡†
        function showVideoExtractDialog() {
            if (!currentFilename) {
                showNotification('è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶', 'error');
                return;
            }

            const currentFile = uploadedFiles[currentFileIndex];
            if (currentFile.type !== 'video') {
                showNotification('å½“å‰æ–‡ä»¶ä¸æ˜¯è§†é¢‘', 'error');
                return;
            }

            const dialogContent = `
                <div style="text-align: left; line-height: 1.6;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">ğŸ¬ è§†é¢‘å¸§æå–è®¾ç½®</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¸§æå–é—´éš”ï¼š</label>
                        <select id="frameInterval" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="1">æ¯1å¸§æå–ä¸€æ¬¡ï¼ˆæœ€å¯†é›†ï¼‰</option>
                            <option value="2" selected>æ¯2å¸§æå–ä¸€æ¬¡</option>
                            <option value="5">æ¯5å¸§æå–ä¸€æ¬¡</option>
                            <option value="10">æ¯10å¸§æå–ä¸€æ¬¡</option>
                            <option value="15">æ¯15å¸§æå–ä¸€æ¬¡</option>
                            <option value="30">æ¯30å¸§æå–ä¸€æ¬¡ï¼ˆç¨€ç–ï¼‰</option>
                        </select>
                    </div>

                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9; margin-bottom: 20px;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong><br>
                        â€¢ é—´éš”è¶Šå°ï¼Œæå–çš„å›¾ç‰‡è¶Šå¤šï¼Œå¤„ç†æ—¶é—´è¶Šé•¿<br>
                        â€¢ å»ºè®®å…ˆç”¨è¾ƒå¤§é—´éš”æµ‹è¯•ï¼Œå†æ ¹æ®éœ€è¦è°ƒæ•´<br>
                        â€¢ 120å¸§è§†é¢‘ï¼Œé—´éš”2å¸§ = 60å¼ å›¾ç‰‡
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="startVideoExtraction()" class="btn" style="flex: 1;">
                            <i class="fas fa-film"></i> å¼€å§‹æå–
                        </button>
                        <button onclick="closeModal()" class="btn btn-secondary" style="flex: 1;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            showModal(dialogContent);
        }

        // å¼€å§‹è§†é¢‘å¸§æå–
        function startVideoExtraction() {
            const frameInterval = parseInt(document.getElementById('frameInterval').value);
            closeModal();

            showNotification('æ­£åœ¨æå–è§†é¢‘å¸§...', 'info');

            // æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
            const progressContent = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">ğŸ¬ è§†é¢‘å¸§æå–ä¸­</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="width: 300px; height: 20px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin: 0 auto;">
                            <div id="extractProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
                        </div>
                        <p id="extractStatus" style="margin-top: 10px; color: #666;">å‡†å¤‡ä¸­...</p>
                        <p id="extractDetails" style="margin-top: 5px; color: #999; font-size: 12px;">æ­£åœ¨åˆ†æè§†é¢‘...</p>
                    </div>
                    
                    <button class="btn btn-danger btn-sm" onclick="cancelVideoExtraction()" id="cancelExtractBtn">
                        <i class="fas fa-times"></i> å–æ¶ˆæå–
                    </button>
                </div>
            `;
            
            showModal(progressContent, false); // ä¸å¯å…³é—­çš„æ¨¡æ€æ¡†
            
            // å¯åŠ¨è¿›åº¦åŠ¨ç”»
            startProgressAnimation();

            fetch(`${API_BASE_URL}/extract_video_frames`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    filename: currentFilename,
                    frame_interval: frameInterval
                })
            })
            .then(response => response.json())
            .then(data => {
                if (extractionAborted) {
                    return; // å¦‚æœå·²å–æ¶ˆï¼Œä¸å¤„ç†å“åº”
                }
                
                if (data.error) {
                    closeModal();
                    showNotification(data.error, 'error');
                    return;
                }

                // å®Œæˆè¿›åº¦åŠ¨ç”»
                completeProgressAnimation(data.extracted_count);

                // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
                uploadedFiles = uploadedFiles.concat(data.extracted_files || []);
                
                showNotification(
                    `è§†é¢‘å¸§æå–å®Œæˆï¼å…±æå– ${data.extracted_count} å¼ å›¾ç‰‡ï¼ˆé—´éš”${frameInterval}å¸§ï¼‰`, 
                    'success'
                );

                // å¦‚æœæœ‰æå–çš„å¸§ï¼Œæ˜¾ç¤ºæµè§ˆå™¨æ§åˆ¶
                if (uploadedFiles.length > 1) {
                    showImageBrowser();
                    updateImageBrowserInfo();
                }
            })
            .catch(error => {
                closeModal();
                showNotification('è§†é¢‘å¸§æå–å¤±è´¥: ' + error.message, 'error');
                console.error('Video frame extraction failed:', error);
            });
        }

        // è§†é¢‘æå–ç›¸å…³å˜é‡
        let extractionAborted = false;
        let progressAnimationId = null;

        // å¯åŠ¨è¿›åº¦åŠ¨ç”»
        function startProgressAnimation() {
            extractionAborted = false;
            let progress = 0;
            const progressBar = document.getElementById('extractProgress');
            const statusText = document.getElementById('extractStatus');
            const detailsText = document.getElementById('extractDetails');
            
            if (!progressBar) return;
            
            // æ¨¡æ‹Ÿè¿›åº¦åŠ¨ç”»
            function animateProgress() {
                if (extractionAborted) return;
                
                progress += Math.random() * 2; // éšæœºå¢åŠ è¿›åº¦
                if (progress > 90) progress = 90; // æœ€å¤šåˆ°90%ï¼Œç­‰çœŸå®å®Œæˆæ—¶åˆ°100%
                
                progressBar.style.width = progress + '%';
                statusText.textContent = `æå–è¿›åº¦: ${Math.round(progress)}%`;
                
                // éšæœºæ›´æ–°è¯¦ç»†ä¿¡æ¯
                const details = [
                    'æ­£åœ¨åˆ†æè§†é¢‘ä¿¡æ¯...',
                    'æ­£åœ¨è¯»å–è§†é¢‘å¸§...',
                    'æ­£åœ¨ä¿å­˜å›¾ç‰‡æ–‡ä»¶...',
                    'æ­£åœ¨å¤„ç†è§†é¢‘æ•°æ®...'
                ];
                detailsText.textContent = details[Math.floor(Math.random() * details.length)];
                
                if (progress < 90) {
                    progressAnimationId = setTimeout(animateProgress, 500 + Math.random() * 1000);
                }
            }
            
            animateProgress();
        }

        // å–æ¶ˆè§†é¢‘æå–
        function cancelVideoExtraction() {
            extractionAborted = true;
            if (progressAnimationId) {
                clearTimeout(progressAnimationId);
            }
            
            closeModal();
            showNotification('å·²å–æ¶ˆè§†é¢‘å¸§æå–', 'warning');
        }

        // å®Œæˆè¿›åº¦åŠ¨ç”»
        function completeProgressAnimation(extractedCount) {
            if (progressAnimationId) {
                clearTimeout(progressAnimationId);
            }
            
            const progressBar = document.getElementById('extractProgress');
            const statusText = document.getElementById('extractStatus');
            const detailsText = document.getElementById('extractDetails');
            
            if (progressBar) {
                progressBar.style.width = '100%';
                statusText.textContent = 'æå–å®Œæˆï¼';
                detailsText.textContent = `æˆåŠŸæå– ${extractedCount} å¼ å›¾ç‰‡`;
                
                setTimeout(() => {
                    closeModal();
                }, 1500); // 1.5ç§’åè‡ªåŠ¨å…³é—­
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(content, closable = true) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 500px; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            modalContent.innerHTML = content;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆå¦‚æœå…è®¸ï¼‰
            if (closable) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.remove());
        }

        function autoAnnotateVideo() {
            if (!currentFilename) {
                showNotification('è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶', 'error');
                return;
            }

            const currentFile = uploadedFiles[currentFileIndex];
            if (currentFile.type !== 'video') {
                showNotification('å½“å‰æ–‡ä»¶ä¸æ˜¯è§†é¢‘', 'error');
                return;
            }

            if (confirm('æ˜¯å¦å…ˆæå–è§†é¢‘å¸§ï¼Œç„¶åè¿›è¡Œæ‰¹é‡æ ‡æ³¨ï¼Ÿ')) {
                showVideoExtractDialog();
            }
        }

        // å¯¼å‡ºå®Œæ•´æ•°æ®é›†
        function exportDataset() {
            showNotification('æ­£åœ¨å‡†å¤‡å¯¼å‡ºå®Œæ•´æ•°æ®é›†...', 'info');
            
            const datasetName = document.getElementById('datasetName').value || 'my_yolo_dataset';
            const includeImages = document.getElementById('includeImages').checked;
            const format = document.getElementById('exportFormat').value;
            
            const requestData = {
                format: format,
                include_images: includeImages,
                dataset_name: datasetName
            };

            fetch(`${API_BASE_URL}/export_dataset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'å¯¼å‡ºå¤±è´¥');
                    });
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${datasetName}_${format}_dataset.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('å®Œæ•´æ•°æ®é›†å¯¼å‡ºæˆåŠŸï¼', 'success');
            })
            .catch(error => {
                showNotification('æ•°æ®é›†å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                console.error('Dataset export failed:', error);
            });
        }

        // Canvasç»˜å›¾åŠŸèƒ½
        function startDrawing(e) {
            if (!currentImage) return;
            
            // å¤šè¾¹å½¢æ¨¡å¼ä¸‹ä¸ä½¿ç”¨æ‹–æ‹½ç»˜åˆ¶
            if (annotationMode === 'polygon') {
                return;
            }
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!currentImage) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            if (annotationMode === 'rectangle' && isDrawing) {
                // çŸ©å½¢æ¨¡å¼ï¼šç»˜åˆ¶æ‹–æ‹½çš„æ¡†
                redrawCanvas();
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
            } else if (annotationMode === 'polygon' && isDrawingPolygon && polygonPoints.length > 0) {
                // å¤šè¾¹å½¢æ¨¡å¼ï¼šæ˜¾ç¤ºä»æœ€åä¸€ä¸ªç‚¹åˆ°é¼ æ ‡çš„çº¿
                redrawCanvas();
                const lastPoint = polygonPoints[polygonPoints.length - 1];
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(lastPoint[0], lastPoint[1]);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
            }
        }

        function stopDrawing(e) {
            if (!currentImage) return;
            
            // å¤šè¾¹å½¢æ¨¡å¼ä¸‹ä¸ä½¿ç”¨æ­¤å‡½æ•°
            if (annotationMode === 'polygon') {
                return;
            }
            
            if (!isDrawing) return;
            
            isDrawing = false;
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;
            
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            
            if (width > 10 && height > 10) {
                const manualClassInput = document.getElementById('manualAnnotationClass');
                const inputClassName = manualClassInput.value.trim();
                
                // æŸ¥æ‰¾æ˜¯å¦æ˜¯å·²çŸ¥ç±»åˆ«
                let selectedClassId = -1;
                if (classes && classes.length > 0) {
                    const knownClassIndex = classes.findIndex(cls => cls.toLowerCase() === inputClassName.toLowerCase());
                    if (knownClassIndex >= 0) {
                        selectedClassId = knownClassIndex;
                    }
                }
                
                // å¦‚æœæ˜¯è‡ªå®šä¹‰ç±»åˆ«ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€ID
                if (selectedClassId === -1) {
                    selectedClassId = 1000 + Date.now() % 10000;
                }
                
                // åˆ›å»ºçŸ©å½¢æ ‡æ³¨
                const newAnnotation = {
                    id: Date.now(),
                    class_id: selectedClassId,
                    class_name: inputClassName || 'unknown',
                    confidence: 1.0,
                    bbox: [Math.min(startX, endX), Math.min(startY, endY), width, height],
                    shape_type: 'rectangle'
                };
                
                annotations.push(newAnnotation);
                updateAnnotationList();
                updateClassCounts();
                setTimeout(autoSaveProgress, 500);
            }
            
            redrawCanvas();
        }

        function handleCanvasClick(e) {
            if (!currentImage || annotationMode !== 'polygon') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åˆ°ç¬¬ä¸€ä¸ªç‚¹é™„è¿‘ï¼ˆé—­åˆå¤šè¾¹å½¢ï¼‰
            if (polygonPoints.length >= 3) {
                const firstPoint = polygonPoints[0];
                const dist = Math.sqrt((x - firstPoint[0]) ** 2 + (y - firstPoint[1]) ** 2);
                if (dist < 10) {
                    finishPolygon();
                    return;
                }
            }
            
            // æ·»åŠ æ–°ç‚¹
            polygonPoints.push([x, y]);
            if (!isDrawingPolygon) {
                isDrawingPolygon = true;
            }
            
            redrawCanvas();
        }

        function finishPolygon(e) {
            if (!currentImage || annotationMode !== 'polygon' || polygonPoints.length < 3) {
                return;
            }
            
            // åˆ›å»ºå¤šè¾¹å½¢æ ‡æ³¨
            const manualClassInput = document.getElementById('manualAnnotationClass');
            const inputClassName = manualClassInput.value.trim();
            
            let selectedClassId = -1;
            if (classes && classes.length > 0) {
                const knownClassIndex = classes.findIndex(cls => cls.toLowerCase() === inputClassName.toLowerCase());
                if (knownClassIndex >= 0) {
                    selectedClassId = knownClassIndex;
                }
            }
            
            if (selectedClassId === -1) {
                selectedClassId = 1000 + Date.now() % 10000;
            }
            
            // è®¡ç®—è¾¹ç•Œæ¡†ï¼ˆç”¨äºå…¼å®¹æ€§ï¼‰
            const xs = polygonPoints.map(p => p[0]);
            const ys = polygonPoints.map(p => p[1]);
            const minX = Math.min(...xs);
            const maxX = Math.max(...xs);
            const minY = Math.min(...ys);
            const maxY = Math.max(...ys);
            
            const newAnnotation = {
                id: Date.now(),
                class_id: selectedClassId,
                class_name: inputClassName || 'unknown',
                confidence: 1.0,
                bbox: [minX, minY, maxX - minX, maxY - minY],
                segmentation: [...polygonPoints],  // å¤åˆ¶ç‚¹æ•°ç»„
                shape_type: 'polygon'
            };
            
            annotations.push(newAnnotation);
            updateAnnotationList();
            updateClassCounts();
            setTimeout(autoSaveProgress, 500);
            
            // é‡ç½®å¤šè¾¹å½¢çŠ¶æ€
            polygonPoints = [];
            isDrawingPolygon = false;
            
            redrawCanvas();
            showNotification('å¤šè¾¹å½¢æ ‡æ³¨å·²æ·»åŠ ', 'success');
        }

        // é”®ç›˜å¿«æ·é”®å¤„ç†
        function handleKeyDown(event) {
            // å¤šè¾¹å½¢æ¨¡å¼ä¸‹çš„ç‰¹æ®ŠæŒ‰é”®
            if (annotationMode === 'polygon' && isDrawingPolygon) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    finishPolygon();
                    return;
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    polygonPoints = [];
                    isDrawingPolygon = false;
                    redrawCanvas();
                    showNotification('å·²å–æ¶ˆå¤šè¾¹å½¢æ ‡æ³¨', 'info');
                    return;
                }
            }
            
            // å¿½ç•¥åœ¨è¾“å…¥æ¡†ä¸­çš„æŒ‰é”®
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }

            switch(event.key) {
                case 'ArrowLeft':
                    event.preventDefault();
                    if (uploadedFiles.length > 1) {
                        previousImage();
                    }
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    if (uploadedFiles.length > 1) {
                        nextImage();
                    }
                    break;
                case ' ':  // ç©ºæ ¼é”®
                    event.preventDefault();
                    if (currentModel && currentImage) {
                        autoAnnotate();
                    }
                    break;
                case 'Delete':
                case 'Backspace':
                    event.preventDefault();
                    clearAnnotations();
                    break;
                case 'a':
                case 'A':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleSelectAll();
                    }
                    break;
                case 's':
                case 'S':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        if (annotations.length > 0) {
                            exportAnnotations();
                        }
                    }
                    break;
                case 'h':
                case 'H':
                    event.preventDefault();
                    showShortcutsHelp();
                    break;
            }
        }

        // æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
        function showShortcutsHelp() {
            const helpContent = `
                <div style="text-align: left; line-height: 1.6;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">âŒ¨ï¸ é”®ç›˜å¿«æ·é”®</h3>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; font-size: 14px;">
                        <strong>â†/â†’</strong><span>ä¸Šä¸€å¼ /ä¸‹ä¸€å¼ å›¾ç‰‡</span>
                        <strong>ç©ºæ ¼</strong><span>è‡ªåŠ¨æ ‡æ³¨</span>
                        <strong>Delete</strong><span>æ¸…é™¤æ ‡æ³¨</span>
                        <strong>Ctrl+A</strong><span>å…¨é€‰/å–æ¶ˆç±»åˆ«</span>
                        <strong>Ctrl+S</strong><span>å¯¼å‡ºæ ‡æ³¨</span>
                        <strong>H</strong><span>æ˜¾ç¤ºå¸®åŠ©</span>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f0fff4; border-radius: 6px; font-size: 12px;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>åœ¨è¾“å…¥æ¡†ä¸­æ—¶å¿«æ·é”®ä¼šè¢«ç¦ç”¨
                    </div>
                </div>
            `;
            
            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            content.innerHTML = helpContent + 
                '<button onclick="this.closest(\'.modal\').remove()" class="btn" style="margin-top: 20px; width: 100%;">å…³é—­</button>';
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        function autoSaveProgress() {
            if (currentSessionId) {
                const saveData = {
                    sessionId: currentSessionId,
                    filename: currentFilename,
                    annotations: annotations || [],
                    uploadedFiles: uploadedFiles || [],
                    currentFileIndex: currentFileIndex || 0,
                    selectedClassIds: selectedClassIds || [],
                    currentModel: currentModel,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('yolo_tool_autosave', JSON.stringify(saveData));
                console.log('âœ… è‡ªåŠ¨ä¿å­˜å®Œæˆ:', new Date().toLocaleTimeString());
            }
        }

        // æ¢å¤è‡ªåŠ¨ä¿å­˜çš„è¿›åº¦
        function restoreAutoSave() {
            try {
                const saved = localStorage.getItem('yolo_tool_autosave');
                if (saved) {
                    const data = JSON.parse(saved);
                    const saveTime = new Date(data.timestamp);
                    const timeDiff = (new Date() - saveTime) / (1000 * 60); // åˆ†é’Ÿ
                    
                    if (timeDiff < 60) { // 60åˆ†é’Ÿå†…çš„è‡ªåŠ¨ä¿å­˜
                        const timeText = timeDiff < 1 ? 'åˆšæ‰' : `${timeDiff.toFixed(0)} åˆ†é’Ÿå‰`;
                        const hasData = (data.annotations && data.annotations.length > 0) || 
                                       (data.uploadedFiles && data.uploadedFiles.length > 0);
                        
                        if (hasData) {
                            const message = `å‘ç° ${timeText} çš„è‡ªåŠ¨ä¿å­˜ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ\nåŒ…å«ï¼š${data.annotations?.length || 0} ä¸ªæ ‡æ³¨ï¼Œ${data.uploadedFiles?.length || 0} ä¸ªæ–‡ä»¶`;
                            
                            if (confirm(message)) {
                                console.log('ğŸ”„ å¼€å§‹æ¢å¤è‡ªåŠ¨ä¿å­˜æ•°æ®...');
                                
                                // æ¢å¤åŸºæœ¬çŠ¶æ€
                                annotations = data.annotations || [];
                                currentSessionId = data.sessionId;
                                currentFilename = data.filename;
                                uploadedFiles = data.uploadedFiles || [];
                                currentFileIndex = data.currentFileIndex || 0;
                                selectedClassIds = data.selectedClassIds || [];
                                currentModel = data.currentModel;
                                
                                // å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ¢å¤æ˜¾ç¤º
                                if (uploadedFiles.length > 0) {
                                    console.log('ğŸ“ æ¢å¤æ–‡ä»¶åˆ—è¡¨:', uploadedFiles.length, 'ä¸ªæ–‡ä»¶');
                                    
                                    // æ˜¾ç¤ºå›¾ç‰‡æµè§ˆå™¨ï¼ˆå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼‰
                                    if (uploadedFiles.length > 1) {
                                        showImageBrowser();
                                        updateImageBrowserInfo();
                                    }
                                    
                                    // åŠ è½½å½“å‰æ–‡ä»¶
                                    loadCurrentFile();
                                }
                                
                                // æ›´æ–°UI
                                updateAnnotationList();
                                updateClassCounts();
                                
                                // å¦‚æœæœ‰æ ‡æ³¨ä¸”æœ‰å½“å‰å›¾ç‰‡ï¼Œé‡ç»˜canvas
                                if (annotations.length > 0) {
                                    setTimeout(() => {
                                        if (currentImage) {
                                            redrawCanvas();
                                            console.log('ğŸ¨ é‡ç»˜äº†', annotations.length, 'ä¸ªæ ‡æ³¨');
                                        }
                                    }, 1000);
                                }
                                
                                const statsText = `å·²æ¢å¤ï¼š${annotations.length} ä¸ªæ ‡æ³¨ï¼Œ${uploadedFiles.length} ä¸ªæ–‡ä»¶`;
                                showNotification(statsText, 'success');
                                console.log('âœ… è‡ªåŠ¨ä¿å­˜æ¢å¤å®Œæˆ');
                            }
                        }
                    } else {
                        // æ¸…é™¤è¿‡æœŸçš„è‡ªåŠ¨ä¿å­˜
                        localStorage.removeItem('yolo_tool_autosave');
                        console.log('ğŸ—‘ï¸ æ¸…é™¤è¿‡æœŸçš„è‡ªåŠ¨ä¿å­˜æ•°æ®');
                    }
                }
            } catch (e) {
                console.warn('æ¢å¤è‡ªåŠ¨ä¿å­˜å¤±è´¥:', e);
                showNotification('æ¢å¤è‡ªåŠ¨ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // é€šçŸ¥ç³»ç»Ÿ
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // æ”¯æŒå¤šè¡Œæ–‡æœ¬ï¼šå°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>æ ‡ç­¾
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}"></i>
                ${formattedMessage}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
            
            // è§¦å‘è‡ªåŠ¨ä¿å­˜
            if (type === 'success' || (currentSessionId && (annotations.length > 0 || uploadedFiles.length > 0))) {
                setTimeout(autoSaveProgress, 1000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤è‡ªåŠ¨ä¿å­˜
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(restoreAutoSave, 1000);
        });
        
        // é¡µé¢å¸è½½å‰è‡ªåŠ¨ä¿å­˜
        window.addEventListener('beforeunload', function(e) {
            if (currentSessionId && (annotations.length > 0 || uploadedFiles.length > 0)) {
                autoSaveProgress();
                console.log('ğŸ’¾ é¡µé¢é€€å‡ºå‰è‡ªåŠ¨ä¿å­˜å®Œæˆ');
            }
        });
        
        // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯5åˆ†é’Ÿï¼‰
        setInterval(function() {
            if (currentSessionId && (annotations.length > 0 || uploadedFiles.length > 0)) {
                autoSaveProgress();
                console.log('â° å®šæ—¶è‡ªåŠ¨ä¿å­˜å®Œæˆ');
            }
        }, 5 * 60 * 1000); // 5åˆ†é’Ÿ

        // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        // æ¸…é™¤å½“å‰ä¼šè¯çš„æ‰€æœ‰æ–‡ä»¶
        function clearCurrentSession() {
            if (!currentSessionId || !uploadedFiles || uploadedFiles.length === 0) {
                showNotification('æ²¡æœ‰å½“å‰ä¼šè¯æ–‡ä»¶å¯æ¸…é™¤', 'warning');
                return;
            }

            if (!confirm(`ç¡®å®šè¦æ¸…é™¤å½“å‰ä¸Šä¼ çš„ ${uploadedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            showNotification('æ­£åœ¨æ¸…é™¤å½“å‰ä¼šè¯æ–‡ä»¶...', 'info');

            fetch(`${API_BASE_URL}/clear_session/${currentSessionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }

                // æ¸…ç†å‰ç«¯çŠ¶æ€
                currentImage = null;
                currentVideo = null;
                currentFilename = null;
                currentFileIndex = 0;
                annotations = [];
                uploadedFiles = [];
                window.imageAnnotationStatus = {};
                
                // éšè—æ˜¾ç¤ºå…ƒç´ 
                document.getElementById('annotationCanvas').style.display = 'none';
                document.getElementById('videoPlayer').style.display = 'none';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('videoControls').style.display = 'none';
                
                // æ¸…ç©ºç”»å¸ƒ
                if (canvas && ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                // æ›´æ–°UI
                updateAnnotationList();
                updateClassCounts();
                hideImageBrowser();
                document.getElementById('detectionStatistics').style.display = 'none';
                
                showNotification('å½“å‰ä¼šè¯æ–‡ä»¶å·²æ¸…é™¤', 'success');
            })
            .catch(error => {
                showNotification('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
                console.error('æ¸…é™¤å½“å‰ä¼šè¯å¤±è´¥:', error);
            });
        }

        // æ¸…é™¤uploadsæ–‡ä»¶å¤¹çš„æ‰€æœ‰æ–‡ä»¶
        function clearAllUploads() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤uploadsæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            // äºŒæ¬¡ç¡®è®¤
            if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ•´ä¸ªuploadsæ–‡ä»¶å¤¹å—ï¼Ÿ')) {
                return;
            }

            showNotification('æ­£åœ¨æ¸…ç©ºuploadsæ–‡ä»¶å¤¹...', 'info');

            fetch(`${API_BASE_URL}/clear_all_uploads`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('æ¸…ç©ºç»“æœ:', data);
                
                if (data.error) {
                    showNotification('æ¸…ç©ºå¤±è´¥: ' + data.error, 'error');
                    console.error('æ¸…ç©ºå¤±è´¥:', data.error);
                    return;
                }

                // æ¸…ç†å‰ç«¯çŠ¶æ€
                currentImage = null;
                currentVideo = null;
                currentFilename = null;
                currentSessionId = null;
                currentFileIndex = 0;
                annotations = [];
                uploadedFiles = [];
                window.imageAnnotationStatus = {};
                
                // éšè—æ˜¾ç¤ºå…ƒç´ 
                document.getElementById('annotationCanvas').style.display = 'none';
                document.getElementById('videoPlayer').style.display = 'none';
                document.getElementById('placeholder').style.display = 'block';
                document.getElementById('videoControls').style.display = 'none';
                
                // æ¸…ç©ºç”»å¸ƒ
                if (canvas && ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                // æ›´æ–°UI
                updateAnnotationList();
                updateClassCounts();
                hideImageBrowser();
                document.getElementById('detectionStatistics').style.display = 'none';
                
                // æ˜¾ç¤ºç»“æœ
                let message = data.message || 'æ¸…ç©ºå®Œæˆ';
                if (data.failed_files && data.failed_files.length > 0) {
                    message += '\n\néƒ¨åˆ†æ–‡ä»¶åˆ é™¤å¤±è´¥:\n' + data.failed_files.slice(0, 5).join('\n');
                    showNotification(message, 'warning');
                    console.warn('å¤±è´¥çš„æ–‡ä»¶:', data.failed_files);
                } else {
                    showNotification(message, 'success');
                }
            })
            .catch(error => {
                const errorMsg = 'æ¸…ç©ºå¤±è´¥: ' + error.message;
                showNotification(errorMsg, 'error');
                console.error('æ¸…ç©ºuploadsæ–‡ä»¶å¤¹å¤±è´¥:', error);
            });
        }

        function showVersionInfo() {
            const versionContent = `
                <div style="text-align: left; line-height: 1.6;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">ğŸš€ YOLOvæ™ºèƒ½æ ‡æ³¨å·¥å…· v2.0</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">âœ¨ æ–°å¢åŠŸèƒ½</h4>
                        <ul style="font-size: 14px; padding-left: 20px;">
                            <li>ğŸ–¼ï¸ å›¾ç‰‡æµè§ˆå™¨ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼‰</li>
                            <li>ğŸ“ é€‰æ‹©ç°æœ‰æ¨¡å‹æ–‡ä»¶</li>
                            <li>ğŸ¯ é€‰æ‹©æ€§è‡ªåŠ¨æ ‡æ³¨</li>
                            <li>ğŸ“Š è¯¦ç»†æ‰¹é‡å¤„ç†è¿›åº¦</li>
                            <li>ğŸ“¦ å®Œæ•´æ•°æ®é›†å¯¼å‡º</li>
                            <li>âŒ¨ï¸ é”®ç›˜å¿«æ·é”®æ”¯æŒ</li>
                            <li>ğŸ’¾ è‡ªåŠ¨ä¿å­˜/æ¢å¤</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">ğŸ“‹ æ”¯æŒæ ¼å¼</h4>
                        <div style="font-size: 14px;">
                            <strong>æ¨¡å‹ï¼š</strong>YOLOv5, YOLOv8 (.pt)<br>
                            <strong>å›¾ç‰‡ï¼š</strong>JPG, PNG, BMP, WEBP<br>
                            <strong>è§†é¢‘ï¼š</strong>MP4, AVI, MOV<br>
                            <strong>å¯¼å‡ºï¼š</strong>YOLO JSON, COCO JSON, YOLO TXT, Pascal VOC
                        </div>
                    </div>

                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <strong>ğŸ¯ ä½¿ç”¨æç¤ºï¼š</strong><br>
                        â€¢ æ”¯æŒæ‰¹é‡å¤„ç†å’Œé€‰æ‹©æ€§æ ‡æ³¨<br>
                        â€¢ å¯åŒæ—¶ç®¡ç†å¤šä¸ªä¼šè¯<br>
                        â€¢ è‡ªåŠ¨ä¿å­˜é˜²æ­¢æ•°æ®ä¸¢å¤±<br>
                        â€¢ é”®ç›˜å¿«æ·é”®æé«˜æ•ˆç‡
                    </div>
                </div>
            `;
            
            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 600px; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;
            content.innerHTML = versionContent + 
                '<button onclick="this.closest(\'.modal\').remove()" class="btn" style="margin-top: 20px; width: 100%;">å…³é—­</button>';
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>
